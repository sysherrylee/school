<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°ç£å¤§å¯Œç¿ï¼šç’°å³¶å°é”äºº</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-color: #f1f5f9;
      overflow-x: hidden;
    }

    .board-container {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: repeat(7, 1fr);
      gap: 3px;
      width: 100%;
      max-width: 900px;
      aspect-ratio: 1 / 1;
      background-color: #475569;
      border: 6px solid #1e293b;
      border-radius: 16px;
      position: relative;
    }

    .cell {
      background-color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      font-size: 1.1rem;
      font-weight: 900;
      padding: 8px 4px;
      position: relative;
      cursor: default;
      line-height: 1.2;
    }

    .center-area {
      grid-column: 2 / 7;
      grid-row: 2 / 7;
      background-color: #f8fafc;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 32px;
      box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.1);
      z-index: 5;
    }

    .property-color {
      height: 20px;
      width: 100%;
      position: absolute;
      top: 0;
    }

    .player-token {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      position: absolute;
      z-index: 50;
      border: 3px solid white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .dice-box {
      width: 110px;
      height: 110px;
      background: white;
      border: 5px solid #1e293b;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4.5rem;
      cursor: pointer;
      transition: transform 0.1s, background-color 0.2s;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    .dice-box:hover {
      background-color: #f1f5f9;
    }

    .dice-box:active {
      transform: scale(0.9);
    }

    .house-indicator {
      display: flex;
      gap: 4px;
      position: absolute;
      top: 24px;
    }

    .house-dot {
      width: 10px;
      height: 10px;
      background: #f59e0b;
      border-radius: 50%;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    #setup-screen {
      position: fixed;
      inset: 0;
      background: #0f172a;
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .setup-card {
      background: white;
      border-radius: 2.5rem;
      padding: 2rem;
      width: 100%;
      max-width: 38rem;
      max-height: 95vh;
      overflow-y: auto;
    }

    .modal-container {
      background: white;
      border-radius: 2rem;
      width: 100%;
      max-width: 32rem;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .modal-scroll-content {
      overflow-y: auto;
      padding: 2.5rem 2rem 1rem 2rem;
      flex-grow: 1;
    }

    .modal-footer {
      padding: 1rem 2rem 2.5rem 2rem;
      background: white;
      border-top: 1px solid #f1f5f9;
    }

    .modal-body {
      font-size: 1.25rem;
      font-weight: 700;
      color: #475569;
    }

    .money-low {
      color: #ef4444;
      font-weight: 900;
    }

    @media (max-width: 640px) {
      .cell {
        font-size: 0.7rem;
        padding: 4px 2px;
      }

      .property-color {
        height: 12px;
      }

      .player-token {
        width: 16px;
        height: 16px;
      }

      .dice-box {
        width: 80px;
        height: 80px;
        font-size: 3rem;
      }

      .modal-container {
        max-width: 95%;
      }

      .modal-body {
        font-size: 1rem;
      }
    }
  </style>
</head>

<body class="p-2 sm:p-4 flex flex-col items-center">

  <!-- è¨­å®šç•«é¢ -->
  <div id="setup-screen">
    <div class="setup-card shadow-2xl border-4 border-indigo-500">
      <h1 class="text-4xl font-extrabold text-center text-slate-800 mb-2">ğŸ‡¹ğŸ‡¼ å°ç£å¤§å¯Œç¿</h1>
      <p class="text-center text-slate-500 text-lg mb-6 font-bold">ç’°å³¶æ—…è¡Œï¼šå¤šäººäº’å‹•æŒ‘æˆ°</p>

      <div class="mb-6 bg-blue-50 p-5 rounded-3xl border-2 border-blue-100 text-center">
        <label class="block text-lg font-black text-blue-800 mb-2 uppercase">åˆå§‹è³‡é‡‘è¨­å®š (NTD):</label>
        <input type="number" id="initial-money-input" value="20000" step="1000"
          class="w-full px-6 py-3 rounded-2xl border-4 border-blue-200 focus:border-indigo-500 outline-none font-black text-3xl text-center">
      </div>

      <div id="player-configs" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-8"></div>

      <div class="flex flex-col gap-4">
        <button onclick="addPlayerConfig()"
          class="w-full py-3 border-4 border-dashed border-slate-300 rounded-2xl font-black hover:bg-slate-50 transition text-slate-600 text-lg">+
          æ–°å¢ç©å®¶ (æœ€å¤š 6 äºº)</button>
        <button onclick="startGame()"
          class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black hover:bg-indigo-700 shadow-xl transition text-2xl uppercase tracking-widest">ç«‹å³é–‹å§‹éŠæˆ²</button>
      </div>
    </div>
  </div>

  <!-- éŠæˆ²ä¸»ç•«é¢ -->
  <div id="game-ui" class="w-full max-w-5xl opacity-0 transition-opacity duration-1000">
    <div class="flex flex-wrap justify-between items-end mb-4 gap-4">
      <div>
        <h1 class="text-3xl font-black text-slate-800">ğŸ‡¹ğŸ‡¼ å°ç£å¤§å¯Œç¿</h1>
        <p class="text-sm text-slate-600 font-black italic">å¤šç©å®¶æ¨¡å¼ï¼šæœ€é«˜æ”¯æ´ 6 äººéŠç©</p>
      </div>
      <div id="player-status-bars" class="flex gap-2 flex-wrap justify-end flex-1"></div>
    </div>

    <div id="board" class="board-container mx-auto">
      <div class="center-area p-8 text-center" id="center-ui-root">
        <div id="turn-indicator" class="text-2xl font-black mb-3">...</div>
        <div id="dice" class="dice-box shadow-2xl mb-5" onclick="handleRollClick()">ğŸ²</div>
        <div class="flex flex-col gap-3 w-full max-w-[280px] mx-auto">
          <div class="flex gap-2">
            <button id="portfolio-btn" onclick="openPortfolio()"
              class="flex-1 py-3 bg-white border-4 border-slate-200 hover:bg-slate-50 rounded-2xl text-sm font-black shadow-md">ğŸ’¼
              è³‡ç”¢ç®¡ç†</button>
            <button onclick="confirmEndGame()"
              class="flex-1 py-3 bg-indigo-50 border-4 border-indigo-100 rounded-2xl text-sm font-black text-indigo-700 shadow-md">ğŸ†
              çµç®—</button>
          </div>
          <button onclick="confirmReturnToSetup()"
            class="py-2.5 bg-slate-200 rounded-2xl text-xs font-black text-slate-600 hover:bg-slate-300">âš™ï¸
            è¿”å›è¨­å®š</button>
        </div>
      </div>
    </div>
  </div>

  <!-- å½ˆçª—ç³»çµ± -->
  <div id="modal" class="fixed inset-0 bg-slate-900/80 flex items-center justify-center z-[100] hidden p-4">
    <div class="modal-container shadow-2xl">
      <button onclick="closeModalByX()"
        class="absolute top-4 right-6 text-slate-400 hover:text-slate-600 text-3xl font-black z-10">âœ•</button>
      <div id="modalHeader" class="h-2 bg-slate-600 w-full shrink-0"></div>
      <div class="modal-scroll-content text-center">
        <div id="modalIcon" class="text-5xl mb-4">ğŸ </div>
        <h2 id="modalTitle" class="text-3xl font-black mb-4 text-slate-800">æ¨™é¡Œ</h2>
        <div id="modalDesc" class="modal-body text-slate-700 mb-6 leading-relaxed"></div>
        <div id="math-section" class="hidden mb-4 p-5 bg-indigo-50 rounded-3xl border-4 border-indigo-100 text-left">
          <div class="flex justify-between items-center mb-3">
            <p class="text-xs font-black text-indigo-500 uppercase tracking-widest">æ•¸å­¸ç®—å¸³æ™‚é–“</p>
            <button id="btnTeacher"
              class="text-sm text-slate-400 hover:text-indigo-600 underline font-black">è€å¸«ä»£ç®—</button>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between text-lg"><span>åŸæœ¬ç¾é‡‘:</span><span id="math-old"
                class="font-black text-slate-700"></span></div>
            <div class="flex justify-between text-lg font-black text-indigo-600"><span
                id="math-op-label">è®Šå‹•é‡‘é¡:</span><span id="math-change"></span></div>
            <div class="border-t-4 border-indigo-200 pt-4 mt-4">
              <label class="block text-sm text-indigo-500 mb-1 font-black italic">å‰©é¤˜é‡‘é¡ï¼š</label>
              <input type="number" id="math-input"
                class="w-full px-4 py-3 rounded-2xl border-4 border-indigo-300 focus:border-indigo-600 outline-none font-black text-center text-4xl">
            </div>
          </div>
        </div>
      </div>
      <div id="modalOptions" class="modal-footer flex flex-col gap-3 shrink-0">
        <button id="btnPrimary"
          class="w-full py-4 bg-green-500 hover:bg-green-600 text-white font-black rounded-3xl transition shadow-lg text-2xl">ç¢ºå®š</button>
        <button id="btnSecondary"
          class="w-full py-4 bg-slate-100 hover:bg-slate-200 text-slate-700 font-black rounded-3xl transition text-xl">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    const BOARD_DATA = [
      { name: "èµ·é»", type: "start", color: "#34d399" },
      { name: "åŸºéš†", type: "prop", price: 2000, rent: 400, upgrade: 1500, color: "#93c5fd" },
      { name: "å°åŒ—", type: "prop", price: 6500, rent: 1500, upgrade: 4500, color: "#2563eb" },
      { name: "æ©Ÿæœƒ", type: "chance", color: "#facc15" },
      { name: "æ–°åŒ—", type: "prop", price: 5500, rent: 1200, upgrade: 3500, color: "#2563eb" },
      { name: "æ¡ƒåœ’", type: "prop", price: 4500, rent: 900, upgrade: 2800, color: "#3b82f6" },
      { name: "æ–°ç«¹å¸‚", type: "prop", price: 4000, rent: 800, upgrade: 2500, color: "#60a5fa" },
      { name: "æ–°ç«¹ç¸£", type: "prop", price: 3800, rent: 750, upgrade: 2200, color: "#60a5fa" },
      { name: "è‹—æ —", type: "prop", price: 3000, rent: 500, upgrade: 1800, color: "#fbbf24" },
      { name: "å‘½é‹", type: "fate", color: "#f87171" },
      { name: "å°ä¸­", type: "prop", price: 5800, rent: 1300, upgrade: 3800, color: "#f59e0b" },
      { name: "å½°åŒ–", type: "prop", price: 3500, rent: 650, upgrade: 2000, color: "#f59e0b" },
      { name: "ä¼‘æ¯ç«™", type: "rest", color: "#94a3b8" },
      { name: "å—æŠ•", type: "prop", price: 2200, rent: 280, upgrade: 1100, color: "#d97706" },
      { name: "é›²æ—", type: "prop", price: 2800, rent: 500, upgrade: 1500, color: "#d97706" },
      { name: "å˜‰ç¾©å¸‚", type: "prop", price: 2200, rent: 280, upgrade: 1100, color: "#ea580c" },
      { name: "å°å—", type: "prop", price: 4800, rent: 1100, upgrade: 3200, color: "#ea580c" },
      { name: "é«˜é›„", type: "prop", price: 5200, rent: 1200, upgrade: 3500, color: "#dc2626" },
      { name: "å±æ±", type: "prop", price: 3500, rent: 650, upgrade: 2000, color: "#dc2626" },
      { name: "å®œè˜­", type: "prop", price: 3800, rent: 750, upgrade: 2200, color: "#059669" },
      { name: "æ©Ÿæœƒ", type: "chance", color: "#facc15" },
      { name: "èŠ±è“®", type: "prop", price: 3600, rent: 700, upgrade: 2100, color: "#059669" },
      { name: "å°æ±", type: "prop", price: 3400, rent: 650, upgrade: 1900, color: "#059669" },
      { name: "é›¢å³¶", type: "prop", price: 4000, rent: 1000, upgrade: 2500, color: "#7c3aed" }
    ];

    const RENT_MULTIPLIERS = [1, 2, 5, 12];
    const LEVEL_NAMES = ["ç„¡å»ºç¯‰", "å°å‹æˆ¿å±‹", "ä¸­å‹å…¬å¯“", "é«˜ç´šé£¯åº—"];

    const CHANCE_LIST = [
      { title: "å¥åº·ç”Ÿæ´»", icon: "ğŸ", text: "ã€å¥åº·ã€‘å …æŒæ¯å¤©åœ¨æ ¡é‹å‹•ç²å¾—å¥åº·ç”Ÿæ´»çã€‚çå‹µ $2000", amount: 2000 },
      { title: "æ•´ç†é”äºº", icon: "ğŸ“š", text: "ã€ç¶œåˆã€‘ä¸»å‹•æ•´ç†æˆ¿é–“ç²å¾—çå‹µé‡‘ã€‚çå‹µ $1500", amount: 1500 },
      { title: "ç¤¾å€è‹±é›„", icon: "ğŸŒŸ", text: "ã€ç¶œåˆã€‘åƒåŠ ç¤¾å€æ¸…æƒæ´»å‹•ç²å¾—çåŠ©é‡‘ã€‚çå‹µ $2500", amount: 2500 }
    ];

    const FATE_LIST = [
      { title: "äº¤é€šäº‹æ•…", icon: "âš ï¸", text: "ã€ç”Ÿæ´»ã€‘éé¦¬è·¯æ²’çœ‹è»Šå°è‡´æ“¦æ’ï¼Œéœ€è³ å„Ÿé†«ç™‚è²»ã€‚æ”¯å‡º $5000", amount: -5000 },
      { title: "å¼·é¢¨ç½æ", icon: "ğŸŒªï¸", text: "ã€ç½ç¦ã€‘é¢±é¢¨è¥²å°å°è‡´æˆ¿å±‹å—æï¼Œéœ€ç¶­ä¿®ã€‚æ”¯å‡º $7000", amount: -7000 },
      { title: "åœ°éœ‡æµ©åŠ«", icon: "ğŸŒ‹", text: "ã€ç½ç¦ã€‘å¤§åœ°éœ‡é€ æˆåœ°ç”¢ç½æï¼Œé‡å»ºæ”¯å‡ºã€‚æ”¯å‡º $9500", amount: -9500 },
      { title: "æå£æ•™æ", icon: "ğŸ§ª", text: "ã€ç”Ÿæ´»ã€‘åœ¨æ ¡æ‰“ç ´æ˜‚è²´ç²¾å¯†æ•™æã€‚æ”¯å‡º $4000", amount: -4000 }
    ];

    let players = [];
    let gameState = { currentTurn: 0, isMoving: false, properties: BOARD_DATA.map(() => ({ owner: null, level: 0 })), gameOver: false, initialMoney: 20000 };
    let activeCancelCallback = null;

    const PLAYER_COLORS = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#9333ea", "#0d9488"];
    const PLAYER_NAMES = ["ç©å®¶ 1", "ç©å®¶ 2", "ç©å®¶ 3", "ç©å®¶ 4", "ç©å®¶ 5", "ç©å®¶ 6"];
    let configPlayers = [{ type: 'human' }, { type: 'bot' }, { type: 'bot' }, { type: 'bot' }, { type: 'bot' }, { type: 'bot' }];

    function renderSetup() {
      const container = document.getElementById('player-configs');
      container.innerHTML = '';
      configPlayers.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = "flex items-center justify-between p-4 bg-slate-50 rounded-3xl border-2 border-slate-100 shadow-sm";
        div.innerHTML = `<div class="flex items-center gap-4"><div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-black text-sm" style="background:${PLAYER_COLORS[i]}">${i + 1}</div><span class="font-black text-slate-700 text-xl">${PLAYER_NAMES[i]}</span></div><div class="flex gap-1"><button onclick="setPlayerType(${i}, 'human')" class="px-4 py-2 rounded-xl text-[10px] font-black transition ${p.type === 'human' ? 'bg-indigo-600 text-white shadow-md' : 'bg-white border-2 text-slate-400'}">çœŸäºº</button><button onclick="setPlayerType(${i}, 'bot')" class="px-4 py-2 rounded-xl text-[10px] font-black transition ${p.type === 'bot' ? 'bg-indigo-600 text-white shadow-md' : 'bg-white border-2 text-slate-400'}">é›»è…¦</button>${i > 1 ? `<button onclick="removePlayerConfig(${i})" class="text-slate-300 ml-2 text-xl font-black">âœ•</button>` : ''}</div>`;
        container.appendChild(div);
      });
    }

    window.setPlayerType = (idx, type) => { configPlayers[idx].type = type; renderSetup(); };
    window.addPlayerConfig = () => { if (configPlayers.length < 6) { configPlayers.push({ type: 'bot' }); renderSetup(); } };
    window.removePlayerConfig = (idx) => { configPlayers.splice(idx, 1); renderSetup(); };

    window.startGame = () => {
      gameState.initialMoney = parseInt(document.getElementById('initial-money-input').value) || 20000;
      gameState.gameOver = false; gameState.currentTurn = 0;
      gameState.properties = BOARD_DATA.map(() => ({ owner: null, level: 0 }));
      players = configPlayers.map((p, i) => ({ id: i, name: PLAYER_NAMES[i], color: PLAYER_COLORS[i], money: gameState.initialMoney, pos: 0, props: [], isBot: p.type === 'bot', isOut: false }));
      document.getElementById('setup-screen').style.display = 'none';
      document.getElementById('game-ui').classList.remove('opacity-0');
      initStatusBars();
      const board = document.getElementById('board');
      board.innerHTML = ''; renderBoard();
      updateUI(); updateTurnIndicator();
      if (players[0].isBot) setTimeout(startTurn, 1000);
    };

    function initStatusBars() {
      const container = document.getElementById('player-status-bars');
      container.innerHTML = '';
      players.forEach(p => {
        const div = document.createElement('div');
        div.id = `status-bar-${p.id}`;
        div.className = "p-2 rounded-2xl border-b-4 transition-all min-w-[90px] shadow-md";
        div.style.backgroundColor = `${p.color}10`; div.style.borderColor = p.color;
        div.innerHTML = `<div class="text-[9px] font-black" style="color:${p.color}">${p.name}</div><div id="money-${p.id}" class="font-black text-slate-800 text-sm">$${p.money.toLocaleString()}</div>`;
        container.appendChild(div);
      });
    }

    function renderBoard() {
      const board = document.getElementById('board');
      const center = document.createElement('div'); center.className = 'center-area p-4 text-center'; center.id = 'center-ui-root';
      center.innerHTML = `<div id="turn-indicator" class="text-2xl font-black mb-3">...</div><div id="dice" class="dice-box shadow-2xl mb-5" onclick="handleRollClick()">ğŸ²</div><div class="flex flex-col gap-3 w-full max-w-[240px] mx-auto"><div class="flex gap-2"><button id="portfolio-btn" onclick="openPortfolio()" class="flex-1 py-3 bg-white border-4 border-slate-200 rounded-2xl text-sm font-black shadow-md">ğŸ’¼ è³‡ç”¢ç®¡ç†</button><button onclick="confirmEndGame()" class="flex-1 py-3 bg-indigo-50 border-4 border-indigo-100 rounded-2xl text-sm font-black text-indigo-700 shadow-md">ğŸ† çµç®—</button></div><button onclick="confirmReturnToSetup()" class="py-2.5 bg-slate-200 rounded-2xl text-xs font-black text-slate-600">âš™ï¸ è¿”å›è¨­å®š</button></div>`;
      board.appendChild(center);
      const mapping = [0, 1, 2, 3, 4, 5, 6, 23, -1, -1, -1, -1, -1, 7, 22, -1, -1, -1, -1, -1, 8, 21, -1, -1, -1, -1, -1, 9, 20, -1, -1, -1, -1, -1, 10, 19, -1, -1, -1, -1, -1, 11, 18, 17, 16, 15, 14, 13, 12];
      mapping.forEach((idx, i) => {
        if (idx === -1) return;
        const d = BOARD_DATA[idx]; const cell = document.createElement('div'); cell.className = 'cell border-2 border-slate-300'; cell.id = `cell-${idx}`;
        if (d.type === 'prop') cell.innerHTML = `<div class="property-color" style="background-color:${d.color}"></div><div class="house-indicator" id="houses-${idx}"></div><div class="mt-6 text-[18px] font-black">${d.name}</div><div class="text-slate-500 text-[14px] font-black tracking-tighter">$${d.price}</div><div id="owner-name-${idx}" class="text-[11px] font-black text-indigo-600 uppercase"></div>`;
        else cell.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><span class="text-slate-800 text-[18px] font-black">${d.name}</span><span class="text-[11px] opacity-70 font-black">${d.type === 'start' ? 'çé‡‘ $2000' : ''}</span></div>`;
        cell.style.gridRow = Math.floor(i / 7) + 1; cell.style.gridColumn = (i % 7) + 1; board.appendChild(cell);
      });
      updatePlayerTokens();
    }

    function updatePlayerTokens() {
      document.querySelectorAll('.player-token').forEach(t => t.remove());
      players.filter(p => !p.isOut).forEach(p => {
        const target = document.getElementById(`cell-${p.pos}`); if (!target) return;
        const token = document.createElement('div'); token.className = 'player-token shadow-lg'; token.style.backgroundColor = p.color;
        const layouts = [{ t: '10%', l: '10%' }, { t: '10%', l: '40%' }, { t: '10%', l: '70%' }, { b: '10%', l: '10%' }, { b: '10%', l: '40%' }, { b: '10%', l: '70%' }];
        const off = layouts[p.id % 6];
        if (off.t) token.style.top = off.t; if (off.b) token.style.bottom = off.b; if (off.l) token.style.left = off.l; if (off.r) token.style.right = off.r;
        target.appendChild(token);
      });
    }

    async function handleRollClick() { if (gameState.isMoving || gameState.gameOver || players[gameState.currentTurn].isOut || players[gameState.currentTurn].isBot) return; startTurn(); }

    async function startTurn() {
      if (gameState.gameOver) return; const p = players[gameState.currentTurn]; if (p.isOut) { finishTurn(); return; }
      gameState.isMoving = true; const d = document.getElementById('dice'); let roll = 0;
      for (let i = 0; i < 8; i++) { roll = Math.floor(Math.random() * 6) + 1; d.innerText = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'][roll - 1]; await new Promise(r => setTimeout(r, 60)); }
      for (let i = 0; i < roll; i++) { if (gameState.gameOver) return; p.pos = (p.pos + 1) % BOARD_DATA.length; if (p.pos === 0) await handleMoneyChange(p, 2000, "ç¶“éèµ·é»é ˜è–ªæ°´"); updatePlayerTokens(); await new Promise(r => setTimeout(r, 200)); }
      processLanding(p);
    }

    function processLanding(p) {
      if (gameState.gameOver) return; const cellIdx = p.pos; const cell = BOARD_DATA[cellIdx]; const propState = gameState.properties[cellIdx];
      if (cell.type === 'prop') {
        if (propState.owner === null) {
          if (!p.isBot) {
            showModal("ğŸ˜ï¸", `åˆ°é” ${cell.name}`,
              `<div class="mb-4">é€™æ˜¯ä¸€å¡Šç©ºåœ°ï¼Œå”®åƒ¹ <b>$${cell.price.toLocaleString()}</b>ã€‚</div>` +
              `<div class="p-4 bg-blue-50 border-4 border-blue-200 rounded-3xl mb-4 font-black text-blue-800 text-center text-2xl">æ‚¨ç•¶å‰æ‰‹æŒé¤˜é¡: $${p.money.toLocaleString()}</div>` +
              `<div class="text-xl text-slate-500 font-black">åŸæœ¬ç§Ÿé‡‘: $${cell.rent.toLocaleString()}</div>`,
              async () => {
                if (p.money >= cell.price) { await handleMoneyChange(p, -cell.price, `è³¼è²·åœŸåœ° ${cell.name}`); propState.owner = p.id; updateUI(); finishTurn(); }
                else showModal("âŒ", "ç¾é‡‘ä¸è¶³", "ä½ çš„ç¾æ¬¾ä¸è¶³ä»¥è³¼è²·é€™å¡ŠåœŸåœ°ã€‚", finishTurn, null, true, "æˆ‘çŸ¥é“äº†");
              }, finishTurn, false, "æˆ‘è¦è³¼è²·", "æˆ‘ä¸è³¼è²·");
          } else { if (p.money >= cell.price + 1000) { p.money -= cell.price; propState.owner = p.id; updateUI(); } finishTurn(); }
        } else if (propState.owner === p.id) {
          if (propState.level < 3) {
            if (!p.isBot) {
              const upgrades = [
                { name: "å°å‹æˆ¿å±‹", cost: cell.upgrade, mult: RENT_MULTIPLIERS[1] },
                { name: "ä¸­å‹å…¬å¯“", cost: Math.floor(cell.upgrade * 1.8), mult: RENT_MULTIPLIERS[2] },
                { name: "é«˜ç´šé£¯åº—", cost: Math.floor(cell.upgrade * 3.5), mult: RENT_MULTIPLIERS[3] }
              ];
              const cur = upgrades[propState.level];
              const nextRent = cell.rent * cur.mult;
              showModal("ğŸ ", "æŠ•è³‡å»ºè¨­é–‹ç™¼",
                `<div class="mb-4 text-slate-600">æ­¡è¿å›åˆ° ${cell.name}ã€‚ä½ è¦æŠ•å…¥è³‡é‡‘é–‹ç™¼å»ºç¯‰å—ï¼Ÿ</div>` +
                `<div class="p-4 bg-blue-50 border-4 border-blue-200 rounded-3xl mb-4 font-black text-blue-800 text-center text-2xl">æ‚¨ç•¶å‰æ‰‹æŒé¤˜é¡: $${p.money.toLocaleString()}</div>` +
                `<div class="text-left bg-orange-50 p-4 rounded-2xl border-4 border-orange-100 text-lg font-black text-orange-700 space-y-1">ç›®æ¨™ï¼š${cur.name}<br>èŠ±è²»ï¼š$${cur.cost.toLocaleString()}<br>é–‹ç™¼å¾Œç§Ÿé‡‘ï¼š$${nextRent.toLocaleString()} (${cur.mult}å€ï¼)</div>`,
                async () => {
                  if (p.money >= cur.cost) { await handleMoneyChange(p, -cur.cost, `æŠ•è³‡é–‹ç™¼ ${cur.name}`); propState.level++; updateUI(); finishTurn(); }
                  else showModal("âŒ", "é‡‘éŒ¢ä¸è¶³", "ç¾æ¬¾ä¸è¶³ï¼Œç„¡æ³•é€²è¡Œé–‹ç™¼å»ºè¨­ã€‚", finishTurn, null, true, "æˆ‘çŸ¥é“äº†");
                }, finishTurn, false, "ç¢ºèªæŠ•è³‡é–‹ç™¼", "æš«ä¸æŠ•è³‡");
            } else { const cost = [BOARD_DATA[cellIdx].upgrade, Math.floor(BOARD_DATA[cellIdx].upgrade * 1.8), Math.floor(BOARD_DATA[cellIdx].upgrade * 3.5)][propState.level]; if (p.money >= cost + 2000) { p.money -= cost; propState.level++; updateUI(); } finishTurn(); }
          } else showModal("ğŸ¨", cell.name, "é€™è£¡å·²æ˜¯æœ€é«˜ç´šé£¯åº—ï¼Œæ­å–œï¼", finishTurn, null, true);
        } else {
          const rent = Math.floor(cell.rent * RENT_MULTIPLIERS[propState.level]);
          if (!p.isBot) showModal("ğŸ’¸", "æ”¯ä»˜é«˜é¡ç§Ÿé‡‘", `é€™è£¡æ˜¯ ${players[propState.owner].name} çš„é–‹ç™¼å€ã€‚<br><br><div class="text-left text-xl bg-red-50 p-4 rounded-2xl border-4 border-red-200 text-red-600 font-black space-y-2">åŸºç¤ç§Ÿé‡‘: $${cell.rent.toLocaleString()}<br>å»ºç¯‰ç­‰ç´š: ${LEVEL_NAMES[propState.level]}<br>å€ç‡åŠ æˆ: ${RENT_MULTIPLIERS[propState.level]} å€<hr class="border-red-200 my-2">æœ€çµ‚æ‡‰ä»˜é‡‘é¡: $${rent.toLocaleString()}</div>`, async () => { await handlePayment(p, propState.owner, rent); }, null, true, "é–‹å§‹ç®—éŒ¢", "");
          else handlePayment(p, propState.owner, rent);
        }
      } else if (cell.type === 'chance' || cell.type === 'fate') {
        const list = cell.type === 'chance' ? CHANCE_LIST : FATE_LIST;
        const card = list[Math.floor(Math.random() * list.length)];
        if (!p.isBot) showModal(card.icon, card.title, card.text, async () => {
          await handleMoneyChange(p, card.amount, card.title);
          if (p.money < 0) handleDebt(p, null); else finishTurn();
        }, null, true, "é–‹å§‹ç®—éŒ¢", "");
        else { p.money += card.amount; updateUI(); if (p.money < 0) autoBotLiquidate(p); else finishTurn(); }
      } else finishTurn();
    }

    async function handleMoneyChange(player, amount, reason) {
      if (player.isBot) { player.money += amount; updateUI(); return; }
      return new Promise((resolve) => {
        const old = player.money; const exp = old + amount;
        showMathModal(old, amount, reason, exp, (ans) => {
          if (ans === exp) { player.money = exp; updateUI(); resolve(); }
          else if (ans < exp) { showModal("âš ï¸", "è¨ˆç®—éŒ¯èª¤å›‰ï¼", `æ­£ç¢ºæ‡‰ç‚º $${exp.toLocaleString()}ï¼Œä½†ä½ ç®—æˆ $${ans.toLocaleString()}ã€‚<br><br>é€™è®“ä½ çš„éŒ¢è®Šæ›´å°‘äº†ï¼Œä½†æˆ‘å€‘æœƒä»¥ä½ çš„ã€ŒéŒ¯èª¤çµæœã€ç‚ºæº–å–”ï¼`, () => { player.money = ans; updateUI(); resolve(); }, null, true, "æ¥å—ä»£åƒ¹"); }
          else showModal("ğŸš«", "ä¸å‡†å ±å‡å¸³ï¼", `å‰©é¤˜é‡‘é¡ä¸èƒ½æ¯”æ­£ç¢ºçš„é‚„å¤šï¼Œè«‹é‡æ–°æ ¸ç®—èª å¯¦ç”³å ±ã€‚`, () => { handleMoneyChange(player, amount, reason).then(resolve); }, null, true, "é‡æ–°ç®—ä¸€æ¬¡", "");
        });
      });
    }

    function showMathModal(old, change, reason, expected, cb) {
      const m = document.getElementById('modal'); const s = document.getElementById('math-section'); const i = document.getElementById('math-input');
      document.getElementById('modalIcon').innerText = change >= 0 ? "ğŸ’°" : "ğŸ’¸";
      document.getElementById('modalTitle').innerText = "ç†è²¡æ•¸å­¸æŒ‘æˆ°";
      document.getElementById('modalDesc').innerHTML = `ç™¼ç”Ÿäº‹ä»¶ï¼š<span class="font-black text-slate-900">${reason}</span>`; s.classList.remove('hidden');
      document.getElementById('math-old').innerText = `$${old.toLocaleString()}`;
      document.getElementById('math-change').innerText = `${change >= 0 ? '+' : ''} $${change.toLocaleString()}`;
      document.getElementById('math-op-label').innerText = change >= 0 ? "è®Šå‹•æ”¶å…¥:" : "è®Šå‹•æ”¯å‡º:"; i.value = "";
      document.getElementById('btnTeacher').onclick = (e) => { e.preventDefault(); i.value = expected; document.getElementById('btnPrimary').click(); };
      document.getElementById('btnPrimary').innerText = "ç¢ºèªæäº¤ç¸½é¡";
      document.getElementById('btnPrimary').onclick = () => { const v = parseInt(i.value); if (isNaN(v)) return; m.classList.add('hidden'); s.classList.add('hidden'); activeCancelCallback = null; cb(v); };
      document.getElementById('btnSecondary').classList.add('hidden'); m.classList.remove('hidden'); setTimeout(() => i.focus(), 100);
    }

    async function handlePayment(fromP, toIdx, amt) {
      await handleMoneyChange(fromP, -amt, `å‘ ${players[toIdx].name} æ”¯ä»˜æ¬¾é …`);
      if (fromP.money >= 0) { if (toIdx !== null) players[toIdx].money += amt; updateUI(); finishTurn(); }
      else { handleDebt(fromP, toIdx); }
    }

    function handleDebt(player, creditorIdx) {
      if (player.money >= 0) { finishTurn(); return; }
      const hasProps = gameState.properties.some(pr => pr.owner === player.id);
      if (!hasProps) { declareBankruptcy(player); return; }
      showModal("ğŸ“‰", "å…¥ä¸æ•·å‡º (è² å‚µ)", `<div class="text-2xl font-black text-red-600">ã€${player.name}ã€‘</div>ä½ ç›®å‰é¤˜é¡ç‚º $${player.money.toLocaleString()}ï¼Œå·²ç¶“èµ¤å­—äº†ï¼<br>å¿…é ˆç«‹å³è³£åœ°æ›éŒ¢ï¼Œå¦å‰‡ç„¡æ³•ç¹¼çºŒéŠæˆ²ã€‚`, () => {
        openPortfolio(() => {
          if (player.money < 0) handleDebt(player, creditorIdx);
          else showModal("ğŸ’°", "å‚µå‹™æ¸…å„Ÿ", `ã€${player.name}ã€‘å·²ç¶“æ¸…å„Ÿå‚µå‹™ï¼`, () => finishTurn(), null, true, "å¤ªå¥½äº†");
        }, true);
      }, null, true, "å‰å¾€è³£åœ°æ›éŒ¢");
    }

    function autoBotLiquidate(bot) {
      showModal("ğŸ’¼", "é›»è…¦è‡ªå‹•ä»£ç®¡", `<b>ã€${bot.name}ã€‘</b>æ­£åœ¨ç·Šæ€¥è®Šè³£è³‡ç”¢ä»¥å„Ÿé‚„å‚µå‹™...`, () => {
        for (let i = 0; i < gameState.properties.length; i++) {
          if (gameState.properties[i].owner === bot.id) {
            const d = BOARD_DATA[i]; const s = gameState.properties[i];
            const sellP = Math.floor((d.price + (s.level * d.upgrade)) * 0.5);
            bot.money += sellP; gameState.properties[i].owner = null; gameState.properties[i].level = 0;
            if (bot.money >= 0) break;
          }
        }
        updateUI(); if (bot.money < 0) declareBankruptcy(bot); else finishTurn();
      }, null, true, "ç¹¼çºŒåŸ·è¡Œ");
    }

    function openPortfolio(cb = null, mandatory = false) {
      const p = players[gameState.currentTurn]; const my = []; gameState.properties.forEach((pr, i) => { if (pr.owner === p.id) my.push(i); });
      if (my.length === 0) { if (mandatory && p.money < 0) declareBankruptcy(p); else showModal("ğŸšï¸", "ç„¡å¯è®Šè³£è³‡ç”¢", "ä½ åä¸‹ç›®å‰æ²’æœ‰åœŸåœ°è³‡ç”¢ã€‚", () => { if (cb) cb(); }, null, true, "æˆ‘çŸ¥é“äº†"); return; }
      const html = my.map(idx => {
        const d = BOARD_DATA[idx]; const s = gameState.properties[idx];
        const sellP = Math.floor((d.price + (s.level * d.upgrade)) * 0.5);
        return `<div class="flex justify-between items-center p-5 border-b-4 border-slate-100 shadow-sm rounded-3xl mb-3"><div class="text-left text-lg font-black text-slate-700">${d.name} (${LEVEL_NAMES[s.level]})</div><button onclick="sellProperty(${idx}, ${sellP}, ${mandatory ? 'true' : 'false'})" class="bg-red-600 text-white text-sm px-6 py-3 rounded-2xl font-black hover:bg-red-700 transition shadow-xl uppercase">è³£åœ°æ› $${sellP.toLocaleString()}</button></div>`;
      }).join('');
      const btnText = (mandatory && p.money < 0) ? `ç¹¼çºŒé‚„å‚µ (å°šæ¬  $${Math.abs(p.money).toLocaleString()})` : "é—œé–‰è³‡ç”¢ç®¡ç†";
      showModal("ğŸ’¼", "è³‡ç”¢è®Šè³£æ‹è³£ä¸­å¿ƒ", `<div class="modal-body space-y-3 mt-2">${html}</div>`, () => { if (cb) cb(); }, null, true, btnText);
    }

    window.sellProperty = async function (idx, p, isDebtFlow) {
      const ownerId = gameState.properties[idx].owner; const plr = players[ownerId];
      document.getElementById('modal').classList.add('hidden');
      await handleMoneyChange(plr, p, `ã€${plr.name}ã€‘æ‹è³£è³‡ç”¢ ${BOARD_DATA[idx].name}`);
      gameState.properties[idx].owner = null; gameState.properties[idx].level = 0;
      updateUI();
      if (isDebtFlow === 'true') { if (plr.money < 0) openPortfolio(null, true); else showModal("ğŸ’°", "å‚µå‹™æ¸…å„Ÿ", `ã€${plr.name}ã€‘æ¸…å„Ÿå®Œæˆï¼`, () => finishTurn(), null, true, "ç¹¼çºŒéŠæˆ²"); }
      else openPortfolio();
    };

    function declareBankruptcy(p) {
      p.isOut = true; p.money = 0; gameState.properties.forEach(pr => { if (pr.owner === p.id) { pr.owner = null; pr.level = 0; } });
      updateUI(); updatePlayerTokens(); const active = players.filter(pl => !pl.isOut);
      if (active.length <= 1) confirmEndGame(true);
      else showModal("ğŸ’€", "æ­£å¼ç ´ç”¢", `ç©å®¶ <b class="text-red-600">ã€${p.name}ã€‘</b> å› ç„¡æ³•å„Ÿé‚„å·¨é¡å‚µå‹™ï¼Œå®£å‘Šç ´ç”¢ä¸¦é€€å‡ºæ¯”è³½ï¼`, finishTurn, null, true, "ç¢ºèªå‡ºå±€");
    }

    function confirmEndGame(auto = false) {
      const showRank = () => {
        gameState.gameOver = true;
        const res = players.map(p => {
          let v = 0; gameState.properties.forEach((pr, i) => { if (pr.owner === p.id) v += BOARD_DATA[i].price + (pr.level * BOARD_DATA[i].upgrade); });
          return { name: p.name, color: p.color, out: p.isOut, cash: p.money, assets: v, total: p.isOut ? 0 : p.money + v };
        }).sort((a, b) => b.total - a.total);
        let h = `<div class="modal-body space-y-4 mt-5">`;
        res.forEach((r, i) => h += `<div class="p-5 rounded-[2rem] border-4 ${i === 0 ? 'border-yellow-400 bg-yellow-50' : 'border-slate-300 bg-slate-100'} text-left shadow-lg"><div class="font-black flex justify-between text-2xl" style="color:${r.color}"><span>${i + 1}. ${r.name} ${r.out ? '(å‡ºå±€)' : ''}</span> <span class="text-slate-700">$${r.total.toLocaleString()}</span></div>æ‰‹æŒç¾é‡‘: $${r.cash.toLocaleString()}<br>è³‡ç”¢ä¼°å€¼: $${r.assets.toLocaleString()}</div>`);
        h += `</div>`;
        showModal("ğŸ“Š", "ç’°å³¶å¤§å†’éšªçµç®—æ¸…å–®", h, () => location.reload(), null, true, "å›é¦–é é‡å•Ÿ", "");
      };
      if (auto) showRank(); else showModal("ğŸ†", "çµæŸéŠæˆ²", "è¦ç¾åœ¨çµç®—æ‰€æœ‰è²¡ç”¢ä¸¦å®£å‘Šæ’åå—ï¼Ÿ", showRank, null, false, "ç«‹å³çµç®—æ’å", "ç¹¼çºŒéŠç©");
    }

    function finishTurn() {
      if (gameState.gameOver) return; gameState.isMoving = false; let c = 0;
      do { gameState.currentTurn = (gameState.currentTurn + 1) % players.length; c++; } while (players[gameState.currentTurn].isOut && c < players.length);
      updateTurnIndicator(); const next = players[gameState.currentTurn]; if (next.isBot && !gameState.gameOver) setTimeout(startTurn, 1000);
    }

    function updateTurnIndicator() {
      const n = players[gameState.currentTurn]; const i = document.getElementById('turn-indicator'); if (i) { i.innerText = `è¼ªåˆ°ï¼š${n.name}`; i.style.color = n.color; }
      players.forEach(p => {
        const b = document.getElementById(`status-bar-${p.id}`);
        if (b) { b.style.opacity = p.isOut ? "0.2" : "1"; b.classList.toggle('border-4', p.id === gameState.currentTurn); }
        const moneyEl = document.getElementById(`money-${p.id}`);
        if (moneyEl && p.money < 5000) moneyEl.classList.add('money-low'); else if (moneyEl) moneyEl.classList.remove('money-low');
      });
    }

    function updateUI() {
      players.forEach(p => { const el = document.getElementById(`money-${p.id}`); if (el) el.innerText = `$${p.money.toLocaleString()}`; });
      gameState.properties.forEach((pr, i) => {
        const o = document.getElementById(`owner-name-${i}`); const h = document.getElementById(`houses-${i}`);
        if (o) { if (pr.owner !== null) { o.innerText = players[pr.owner].name; o.style.color = players[pr.owner].color; h.innerHTML = Array(pr.level).fill('<div class="house-dot"></div>').join(''); } else { o.innerText = ''; h.innerHTML = ''; } }
      });
    }

    window.confirmReturnToSetup = () => showModal("âš™ï¸", "é‡å•Ÿç³»çµ±", "ç¢ºå®šè¦æ”¾æ£„é€²åº¦é‡å•Ÿå—ï¼Ÿ", () => location.reload(), null, false, "ç¢ºå®šé‡è¨­", "ç•™åœ¨éŠæˆ²");
    window.closeModalByX = () => {
      const m = document.getElementById('modal');
      if (m.classList.contains('hidden')) return;
      m.classList.add('hidden');
      if (activeCancelCallback) { const cb = activeCancelCallback; activeCancelCallback = null; cb(); }
      if (gameState.gameOver) location.reload();
    };

    function showModal(icon, title, desc, onC, onX, isA, pBT = "ç¢ºå®š", sBT = "å–æ¶ˆ") {
      const m = document.getElementById('modal'); document.getElementById('modalIcon').innerText = icon;
      document.getElementById('modalTitle').innerText = title; document.getElementById('modalDesc').innerHTML = desc;
      document.getElementById('math-section').classList.add('hidden');
      const bP = document.getElementById('btnPrimary'); const bS = document.getElementById('btnSecondary');
      bP.innerText = pBT; bS.innerText = sBT; bS.classList.toggle('hidden', isA);
      activeCancelCallback = onX;
      bP.onclick = () => { m.classList.add('hidden'); activeCancelCallback = null; if (onC) onC(); };
      if (!isA) bS.onclick = () => { m.classList.add('hidden'); activeCancelCallback = null; if (onX) onX(); };
      m.classList.remove('hidden');
    }

    window.onload = renderSetup;
  </script>
</body>

</html>