<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°ç£å¤§å¯Œç¿ï¼šç’°å³¶å°é”äºº</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-color: #f1f5f9;
      overflow-x: hidden;
    }

    .board-container {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-template-rows: repeat(7, 1fr);
      gap: 2px;
      width: 100%;
      max-width: 800px;
      aspect-ratio: 1 / 1;
      background-color: #cbd5e1;
      border: 4px solid #475569;
      border-radius: 8px;
      position: relative;
    }

    .cell {
      background-color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      font-size: 0.7rem;
      font-weight: bold;
      padding: 4px;
      position: relative;
      cursor: default;
    }

    .center-area {
      grid-column: 2 / 7;
      grid-row: 2 / 7;
      background-color: #f8fafc;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 20px;
      box-shadow: inset 0 0 25px rgba(0, 0, 0, 0.05);
      z-index: 5;
    }

    .property-color {
      height: 12px;
      width: 100%;
      position: absolute;
      top: 0;
    }

    .player-token {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      position: absolute;
      z-index: 50;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .dice-box {
      width: 70px;
      height: 70px;
      background: white;
      border: 4px solid #475569;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .dice-box:active {
      transform: scale(0.9);
    }

    .house-indicator {
      display: flex;
      gap: 2px;
      position: absolute;
      top: 15px;
    }

    .house-dot {
      width: 6px;
      height: 6px;
      background: #f59e0b;
      border-radius: 50%;
    }

    #setup-screen {
      position: fixed;
      inset: 0;
      background: #1e293b;
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }

    .setup-card {
      background: white;
      border-radius: 1.5rem;
      padding: 1.5rem;
      width: 100%;
      max-width: 28rem;
      max-height: 95vh;
      overflow-y: auto;
    }

    .modal-body {
      max-height: 50vh;
      overflow-y: auto;
      padding-right: 4px;
    }

    .modal-body::-webkit-scrollbar {
      width: 4px;
    }

    .modal-body::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }

    .money-low {
      color: #ef4444;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    @media (max-width: 640px) {
      .cell {
        font-size: 0.5rem;
        padding: 2px;
      }

      .property-color {
        height: 8px;
      }

      .player-token {
        width: 12px;
        height: 12px;
      }
    }
  </style>
</head>

<body class="p-2 sm:p-6 flex flex-col items-center">

  <div id="setup-screen">
    <div class="setup-card shadow-2xl">
      <h1 class="text-2xl font-bold text-center text-slate-800 mb-1">ğŸ‡¹ğŸ‡¼ å°ç£å¤§å¯Œç¿</h1>
      <p class="text-center text-slate-500 text-xs mb-4">é è¨­å››äººç’°å³¶æ—…è¡Œè¨­å®š</p>

      <div class="mb-4 bg-blue-50 p-3 rounded-xl border border-blue-100">
        <label class="block text-[10px] font-bold text-blue-700 mb-1 uppercase">åˆå§‹è³‡é‡‘ (NTD):</label>
        <input type="number" id="initial-money-input" value="20000" step="1000"
          class="w-full px-4 py-1.5 rounded-lg border-2 border-blue-200 focus:border-blue-500 outline-none font-bold text-lg">
      </div>

      <div id="player-configs" class="space-y-2 mb-6"></div>

      <div class="flex flex-col gap-2">
        <button onclick="addPlayerConfig()"
          class="w-full py-2 border-2 border-dashed border-slate-200 rounded-xl font-bold hover:bg-slate-50 transition text-slate-500 text-xs">+
          æ–°å¢ç©å®¶</button>
        <button onclick="startGame()"
          class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition">é–‹å§‹ç’°å³¶æ—…è¡Œ</button>
      </div>
    </div>
  </div>

  <div id="game-ui" class="w-full max-w-4xl opacity-0 transition-opacity duration-1000">
    <div class="flex flex-wrap justify-between items-end mb-4 gap-2">
      <div>
        <h1 class="text-xl font-bold text-slate-800">ğŸ‡¹ğŸ‡¼ å°ç£å¤§å¯Œç¿</h1>
        <p class="text-[10px] text-slate-500 font-medium italic">ğŸš¨ è² å‚µæ™‚è«‹è®Šè³£åœ°ç”¢ï¼Œé›»è…¦å°‡è‡ªå‹•ç‚ºæ‚¨æ¸…ç®—ï¼</p>
      </div>
      <div id="player-status-bars" class="flex gap-2 flex-wrap"></div>
    </div>

    <div id="board" class="board-container mx-auto">
      <div class="center-area p-4 text-center" id="center-ui-root">
        <div id="turn-indicator" class="text-lg font-bold mb-1">...</div>
        <div id="dice" class="dice-box shadow-lg mb-3" onclick="handleRollClick()">ğŸ²</div>
        <div class="flex flex-col gap-1.5 w-full max-w-[180px]">
          <div class="flex gap-1">
            <button id="portfolio-btn" onclick="openPortfolio()"
              class="flex-1 py-1.5 bg-white border border-slate-200 hover:bg-slate-50 rounded-lg text-[9px] font-bold shadow-sm">ğŸ’¼
              è³‡ç”¢ç®¡ç†</button>
            <button onclick="confirmEndGame()"
              class="flex-1 py-1.5 bg-indigo-50 border border-indigo-100 rounded-lg text-[9px] font-bold text-indigo-600 shadow-sm">ğŸ†
              çµç®—</button>
          </div>
          <button onclick="confirmReturnToSetup()"
            class="py-1 bg-slate-100 border border-slate-200 rounded-lg text-[9px] font-bold text-slate-400">âš™ï¸
            è¿”å›è¨­å®š</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal System -->
  <div id="modal" class="fixed inset-0 bg-slate-900/70 flex items-center justify-center z-[100] hidden p-4">
    <div class="bg-white rounded-3xl w-full max-w-sm shadow-2xl overflow-hidden transform transition-all scale-100">
      <div id="modalHeader" class="h-1.5 bg-slate-500"></div>
      <div class="p-6 text-center">
        <div id="modalIcon" class="text-5xl mb-2">ğŸ </div>
        <h2 id="modalTitle" class="text-xl font-bold mb-1 text-slate-800">æ¨™é¡Œ</h2>
        <div id="modalDesc" class="modal-body text-slate-600 mb-6 text-sm leading-relaxed"></div>

        <div id="math-section" class="hidden mb-4 p-4 bg-indigo-50 rounded-2xl border border-indigo-100 text-left">
          <div class="flex justify-between items-center mb-2">
            <p class="text-[10px] font-bold text-indigo-500 uppercase tracking-tighter">ç†è²¡è¨ˆç®—</p>
            <button id="btnTeacher" class="text-[9px] text-slate-400 hover:text-indigo-600 underline">æ•™å¸«ä»£ç®—</button>
          </div>
          <div class="space-y-1">
            <div class="flex justify-between text-xs"><span>åŸæœ¬é‡‘é¡:</span><span id="math-old"
                class="font-bold text-slate-700"></span></div>
            <div class="flex justify-between text-xs font-bold text-indigo-600"><span
                id="math-op-label">è®Šå‹•é‡‘é¡:</span><span id="math-change"></span></div>
            <div class="border-t border-indigo-200 pt-2 mt-2">
              <label class="block text-[10px] text-indigo-400 mb-1 font-bold">è«‹è¼¸å…¥è¨ˆç®—å¾Œçš„æœ€æ–°é¤˜é¡ï¼š</label>
              <input type="number" id="math-input"
                class="w-full px-4 py-2 rounded-xl border-2 border-indigo-200 focus:border-indigo-500 outline-none font-bold text-center text-xl">
            </div>
          </div>
        </div>

        <div id="modalOptions" class="flex flex-col gap-2">
          <button id="btnPrimary"
            class="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-2xl transition shadow-md">ç¢ºå®š</button>
          <button id="btnSecondary"
            class="w-full py-3 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-2xl transition">å–æ¶ˆ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const BOARD_DATA = [
      { name: "èµ·é»", type: "start", color: "#34d399" },
      { name: "åŸºéš†", type: "prop", price: 2000, rent: 400, upgrade: 1500, color: "#93c5fd" },
      { name: "å°åŒ—", type: "prop", price: 6500, rent: 1500, upgrade: 4500, color: "#2563eb" },
      { name: "æ©Ÿæœƒ", type: "chance", color: "#facc15" },
      { name: "æ–°åŒ—", type: "prop", price: 5500, rent: 1200, upgrade: 3500, color: "#2563eb" },
      { name: "æ¡ƒåœ’", type: "prop", price: 4500, rent: 900, upgrade: 2800, color: "#3b82f6" },
      { name: "ç«¹å¸‚", type: "prop", price: 4000, rent: 800, upgrade: 2500, color: "#60a5fa" },
      { name: "ç«¹ç¸£", type: "prop", price: 3800, rent: 750, upgrade: 2200, color: "#60a5fa" },
      { name: "è‹—æ —", type: "prop", price: 3000, rent: 500, upgrade: 1800, color: "#fbbf24" },
      { name: "å‘½é‹", type: "fate", color: "#f87171" },
      { name: "å°ä¸­", type: "prop", price: 5800, rent: 1300, upgrade: 3800, color: "#f59e0b" },
      { name: "å½°åŒ–", type: "prop", price: 3500, rent: 650, upgrade: 2000, color: "#f59e0b" },
      { name: "ä¼‘æ¯", type: "rest", color: "#94a3b8" },
      { name: "å—æŠ•", type: "prop", price: 2200, rent: 280, upgrade: 1100, color: "#d97706" },
      { name: "é›²æ—", type: "prop", price: 1800, rent: 200, upgrade: 900, color: "#d97706" },
      { name: "å˜‰å¸‚", type: "prop", price: 2200, rent: 280, upgrade: 1100, color: "#ea580c" },
      { name: "å°å—", type: "prop", price: 4800, rent: 1100, upgrade: 3200, color: "#ea580c" },
      { name: "é«˜é›„", type: "prop", price: 5200, rent: 1200, upgrade: 3500, color: "#dc2626" },
      { name: "å±æ±", type: "prop", price: 3500, rent: 650, upgrade: 2000, color: "#dc2626" },
      { name: "å®œè˜­", type: "prop", price: 3800, rent: 750, upgrade: 2200, color: "#059669" },
      { name: "æ©Ÿæœƒ", type: "chance", color: "#facc15" },
      { name: "èŠ±è“®", type: "prop", price: 3600, rent: 700, upgrade: 2100, color: "#059669" },
      { name: "å°æ±", type: "prop", price: 3400, rent: 650, upgrade: 1900, color: "#059669" },
      { name: "é›¢å³¶", type: "prop", price: 4000, rent: 1000, upgrade: 2500, color: "#7c3aed" }
    ];

    const RENT_MULTIPLIERS = [1, 2, 5, 12];
    const LEVEL_NAMES = ["ç„¡å»ºç¯‰", "å°å‹æˆ¿å±‹", "ä¸­å‹å…¬å¯“", "é«˜ç´šé£¯åº—"];

    const CHANCE_LIST = [
      { title: "é‹å‹•çé‡‘", icon: "ğŸ", text: "ã€å¥åº·ã€‘å …æŒæ¯å¤©åœ¨æ ¡é‹å‹•ç²å¾—å¥åº·ç”Ÿæ´»çå‹µã€‚çå‹µ $2000", amount: 2000 },
      { title: "æ•´ç†é”äºº", icon: "ğŸ“š", text: "ã€ç¶œåˆã€‘ä¸»å‹•æ•´ç†æˆ¿é–“ç²å¾—çå‹µé‡‘ã€‚çå‹µ $1500", amount: 1500 },
      { title: "ç¤¾å€æœå‹™", icon: "ğŸŒŸ", text: "ã€ç¶œåˆã€‘åƒåŠ ç¤¾å€æ¸…æƒæ´»å‹•ç²å¾—çåŠ©é‡‘ã€‚çå‹µ $2500", amount: 2500 }
    ];

    const FATE_LIST = [
      { title: "äº¤é€šäº‹æ•…", icon: "âš ï¸", text: "ã€ç”Ÿæ´»ã€‘éé¦¬è·¯æ²’çœ‹è»Šå°è‡´æ“¦æ’ï¼Œè³ å„Ÿé†«ç™‚è²»ã€‚æ”¯å‡º $5000", amount: -5000 },
      { title: "å¼·é¢¨ç½æ", icon: "ğŸŒªï¸", text: "ã€ç½ç¦ã€‘å¼·é¢±è¥²å°å°è‡´æˆ¿ç”¢å—æç¶­ä¿®è²»ã€‚æ”¯å‡º $7000", amount: -7000 },
      { title: "åœ°éœ‡æµ©åŠ«", icon: "ğŸŒ‹", text: "ã€ç½ç¦ã€‘çªç™¼å¤§åœ°éœ‡é€ æˆç½æé‡å»ºè²»ã€‚æ”¯å‡º $9500", amount: -9500 },
      { title: "æå£æ•™æ", icon: "ğŸ§ª", text: "ã€ç”Ÿæ´»ã€‘åœ¨æ ¡æ‰“ç ´æ˜‚è²´å¯¦é©—æ•™æï¼Œéœ€è³ å„Ÿã€‚æ”¯å‡º $4000", amount: -4000 }
    ];

    let players = [];
    let gameState = {
      currentTurn: 0,
      isMoving: false,
      properties: BOARD_DATA.map(() => ({ owner: null, level: 0 })),
      gameOver: false,
      initialMoney: 20000
    };

    const PLAYER_COLORS = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b"];
    const PLAYER_NAMES = ["ç©å®¶ 1", "ç©å®¶ 2", "ç©å®¶ 3", "ç©å®¶ 4"];
    // é è¨­å››å€‹äººç© (1äºº 3é›»è…¦)
    let configPlayers = [{ type: 'human' }, { type: 'bot' }, { type: 'bot' }, { type: 'bot' }];

    function renderSetup() {
      const container = document.getElementById('player-configs');
      container.innerHTML = '';
      configPlayers.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = "flex items-center justify-between p-2.5 bg-slate-50 rounded-xl border border-slate-100";
        div.innerHTML = `<div class="flex items-center gap-2"><div class="w-7 h-7 rounded-full flex items-center justify-center text-white font-bold text-xs" style="background:${PLAYER_COLORS[i]}">${i + 1}</div><span class="font-bold text-slate-700 text-xs">${PLAYER_NAMES[i]}</span></div><div class="flex gap-1"><button onclick="setPlayerType(${i}, 'human')" class="px-2.5 py-1 rounded-lg text-[10px] font-bold transition ${p.type === 'human' ? 'bg-indigo-600 text-white shadow-sm' : 'bg-white border text-slate-400'}">ç©å®¶</button><button onclick="setPlayerType(${i}, 'bot')" class="px-2.5 py-1 rounded-lg text-[10px] font-bold transition ${p.type === 'bot' ? 'bg-indigo-600 text-white shadow-sm' : 'bg-white border text-slate-400'}">é›»è…¦</button>${i > 1 ? `<button onclick="removePlayerConfig(${i})" class="text-slate-300 ml-1">âœ•</button>` : ''}</div>`;
        container.appendChild(div);
      });
    }

    window.setPlayerType = (idx, type) => { configPlayers[idx].type = type; renderSetup(); };
    window.addPlayerConfig = () => { if (configPlayers.length < 4) { configPlayers.push({ type: 'bot' }); renderSetup(); } };
    window.removePlayerConfig = (idx) => { configPlayers.splice(idx, 1); renderSetup(); };

    window.startGame = () => {
      gameState.initialMoney = parseInt(document.getElementById('initial-money-input').value) || 20000;
      gameState.gameOver = false; gameState.currentTurn = 0;
      gameState.properties = BOARD_DATA.map(() => ({ owner: null, level: 0 }));
      players = configPlayers.map((p, i) => ({ id: i, name: PLAYER_NAMES[i], color: PLAYER_COLORS[i], money: gameState.initialMoney, pos: 0, props: [], isBot: p.type === 'bot', isOut: false }));
      document.getElementById('setup-screen').style.display = 'none';
      document.getElementById('game-ui').classList.remove('opacity-0');
      initStatusBars();
      const board = document.getElementById('board');
      board.innerHTML = ''; renderBoard();
      updateUI(); updateTurnIndicator();
      if (players[0].isBot) setTimeout(startTurn, 1000);
    };

    function initStatusBars() {
      const container = document.getElementById('player-status-bars');
      container.innerHTML = '';
      players.forEach(p => {
        const div = document.createElement('div');
        div.id = `status-bar-${p.id}`;
        div.className = "p-1.5 rounded border-b-2 transition-all min-w-[70px]";
        div.style.backgroundColor = `${p.color}10`; div.style.borderColor = p.color;
        div.innerHTML = `<div class="text-[8px] font-bold" style="color:${p.color}">${p.name}</div><div id="money-${p.id}" class="font-bold text-slate-700 text-[9px]">$${p.money.toLocaleString()}</div>`;
        container.appendChild(div);
      });
    }

    function renderBoard() {
      const board = document.getElementById('board');
      const center = document.createElement('div'); center.className = 'center-area p-4 text-center'; center.id = 'center-ui-root';
      center.innerHTML = `<div id="turn-indicator" class="text-base font-bold mb-1">...</div><div id="dice" class="dice-box shadow-lg mb-3" onclick="handleRollClick()">ğŸ²</div><div class="flex flex-col gap-1.5 w-full max-w-[160px]"><div class="flex gap-1"><button id="portfolio-btn" onclick="openPortfolio()" class="flex-1 py-1.5 bg-white border border-slate-200 rounded text-[9px] font-bold shadow-sm">ğŸ’¼ è³‡ç”¢ç®¡ç†</button><button onclick="confirmEndGame()" class="flex-1 py-1.5 bg-indigo-50 border border-indigo-100 rounded text-[9px] font-bold text-indigo-600 shadow-sm">ğŸ† çµç®—</button></div><button onclick="confirmReturnToSetup()" class="py-1 bg-slate-100 rounded text-[8px] font-bold text-slate-400">âš™ï¸ è¿”å›è¨­å®š</button></div>`;
      board.appendChild(center);
      const mapping = [0, 1, 2, 3, 4, 5, 6, 23, -1, -1, -1, -1, -1, 7, 22, -1, -1, -1, -1, -1, 8, 21, -1, -1, -1, -1, -1, 9, 20, -1, -1, -1, -1, -1, 10, 19, -1, -1, -1, -1, -1, 11, 18, 17, 16, 15, 14, 13, 12];
      mapping.forEach((idx, i) => {
        if (idx === -1) return;
        const d = BOARD_DATA[idx]; const cell = document.createElement('div'); cell.className = 'cell border border-slate-200'; cell.id = `cell-${idx}`;
        if (d.type === 'prop') cell.innerHTML = `<div class="property-color" style="background-color:${d.color}"></div><div class="house-indicator" id="houses-${idx}"></div><div class="mt-4">${d.name}</div><div class="text-slate-400 text-[9px]">$${d.price}</div><div id="owner-name-${idx}" class="text-[7px] font-bold"></div>`;
        else cell.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><span class="text-slate-700">${d.name}</span><span class="text-[7px] opacity-40">${d.type === 'start' ? 'é ˜ 2000' : ''}</span></div>`;
        cell.style.gridRow = Math.floor(i / 7) + 1; cell.style.gridColumn = (i % 7) + 1; board.appendChild(cell);
      });
      updatePlayerTokens();
    }

    function updatePlayerTokens() {
      document.querySelectorAll('.player-token').forEach(t => t.remove());
      players.filter(p => !p.isOut).forEach(p => {
        const target = document.getElementById(`cell-${p.pos}`); if (!target) return;
        const token = document.createElement('div'); token.className = 'player-token shadow-md'; token.style.backgroundColor = p.color;
        const off = [{ t: '15%', l: '15%' }, { t: '15%', r: '15%' }, { b: '15%', l: '15%' }, { b: '15%', r: '15%' }][p.id % 4];
        if (off.t) token.style.top = off.t; if (off.b) token.style.bottom = off.b; if (off.l) token.style.left = off.l; if (off.r) token.style.right = off.r;
        target.appendChild(token);
      });
    }

    async function handleRollClick() { if (gameState.isMoving || gameState.gameOver || players[gameState.currentTurn].isOut || players[gameState.currentTurn].isBot) return; startTurn(); }

    async function startTurn() {
      if (gameState.gameOver) return; const p = players[gameState.currentTurn]; if (p.isOut) { finishTurn(); return; }
      gameState.isMoving = true; const d = document.getElementById('dice'); let roll = 0;
      for (let i = 0; i < 8; i++) { roll = Math.floor(Math.random() * 6) + 1; d.innerText = ['âš€', 'âš', 'âš‚', 'âšƒ', 'âš„', 'âš…'][roll - 1]; await new Promise(r => setTimeout(r, 60)); }
      for (let i = 0; i < roll; i++) { if (gameState.gameOver) return; p.pos = (p.pos + 1) % BOARD_DATA.length; if (p.pos === 0) await handleMoneyChange(p, 2000, "ç¶“éèµ·é»çå‹µ"); updatePlayerTokens(); await new Promise(r => setTimeout(r, 200)); }
      processLanding(p);
    }

    function processLanding(p) {
      if (gameState.gameOver) return; const cellIdx = p.pos; const cell = BOARD_DATA[cellIdx]; const propState = gameState.properties[cellIdx];
      if (cell.type === 'prop') {
        if (propState.owner === null) {
          if (!p.isBot) {
            showModal("ğŸ˜ï¸", `åˆ°é” ${cell.name}`, `é€™æ˜¯ä¸€å¡Šç©ºåœ°ï¼Œå”®åƒ¹ $${cell.price}ã€‚<br><br><span class="text-xs text-blue-500 font-bold">åŸºæœ¬ç§Ÿé‡‘: $${cell.rent}</span>`, async () => {
              if (p.money >= cell.price) { await handleMoneyChange(p, -cell.price, `è³¼è²·åœŸåœ° ${cell.name}`); propState.owner = p.id; updateUI(); finishTurn(); }
              else showModal("âŒ", "è³‡é‡‘ä¸è¶³", "ä½ çš„ç¾æ¬¾ä¸è¶³ä»¥è³¼è²·é€™å¡Šåœ°ã€‚", finishTurn, null, true, "æˆ‘çŸ¥é“äº†");
            }, finishTurn, false, "æˆ‘è¦è³¼è²·", "æˆ‘ä¸è³¼è²·");
          } else {
            if (p.money >= cell.price + 1000) { p.money -= cell.price; propState.owner = p.id; updateUI(); } finishTurn();
          }
        } else if (propState.owner === p.id) {
          if (propState.level < 3) {
            if (!p.isBot) {
              const upgrades = [
                { name: "å°å‹æˆ¿å±‹", cost: cell.upgrade, mult: RENT_MULTIPLIERS[1] },
                { name: "ä¸­å‹å…¬å¯“", cost: Math.floor(cell.upgrade * 1.8), mult: RENT_MULTIPLIERS[2] },
                { name: "é«˜ç´šé£¯åº—", cost: Math.floor(cell.upgrade * 3.5), mult: RENT_MULTIPLIERS[3] }
              ];
              const cur = upgrades[propState.level];
              const nextRent = cell.rent * cur.mult;
              showModal("ğŸ ", "æŠ•è³‡èˆ‡é–‹ç™¼", `æ­¡è¿å›åˆ° ${cell.name}ã€‚<br>ä½ è¦æŠ•å…¥è³‡é‡‘é–‹ç™¼å»ºç¯‰å—ï¼Ÿ<br><br><div class="text-left bg-orange-50 p-2 rounded text-xs font-bold text-orange-600">é–‹ç™¼ç›®æ¨™ï¼š${cur.name}<br>å‡ç´šèŠ±è²»ï¼š$${cur.cost}<br>é–‹ç™¼å¾Œç§Ÿé‡‘ï¼š$${nextRent.toLocaleString()} (${cur.mult}å€åŠ æˆï¼)</div>`, async () => {
                if (p.money >= cur.cost) { await handleMoneyChange(p, -cur.cost, `æŠ•è³‡é–‹ç™¼ ${cur.name}`); propState.level++; updateUI(); finishTurn(); }
                else showModal("âŒ", "é‡‘éŒ¢ä¸è¶³", "ç¾æ¬¾ä¸è¶³ï¼Œç„¡æ³•é€²è¡Œé–‹ç™¼ã€‚", finishTurn, null, true, "æˆ‘çŸ¥é“äº†");
              }, finishTurn, false, "ç¢ºèªæŠ•è³‡", "æš«ä¸æŠ•è³‡");
            } else {
              const cost = [BOARD_DATA[cellIdx].upgrade, Math.floor(BOARD_DATA[cellIdx].upgrade * 1.8), Math.floor(BOARD_DATA[cellIdx].upgrade * 3.5)][propState.level];
              if (p.money >= cost + 2000) { p.money -= cost; propState.level++; updateUI(); } finishTurn();
            }
          } else showModal("ğŸ¨", cell.name, "å·²é–‹ç™¼ç‚ºæœ€é«˜ç´šé£¯åº—ï¼", finishTurn, null, true);
        } else {
          const rent = Math.floor(cell.rent * RENT_MULTIPLIERS[propState.level]);
          if (!p.isBot) showModal("ğŸ’¸", "æ”¯ä»˜é«˜é¡ç§Ÿé‡‘", `é€™è£¡æ˜¯ ${players[propState.owner].name} çš„é ˜åœ°ã€‚<br><br><div class="text-left text-xs bg-red-50 p-2 rounded border border-red-200 text-red-600 font-bold">åŸæœ¬åŸºç¤ç§Ÿé‡‘: $${cell.rent}<br>å»ºç¯‰ç­‰ç´š: ${LEVEL_NAMES[propState.level]}<br>å€ç‡åŠ æˆ: ${RENT_MULTIPLIERS[propState.level]} å€<br>æœ€çµ‚æ‡‰ä»˜ç§Ÿé‡‘: $${rent.toLocaleString()}</div>`, async () => { await handlePayment(p, propState.owner, rent); }, null, true, "é–‹å§‹ç®—éŒ¢", "");
          else handlePayment(p, propState.owner, rent);
        }
      } else if (cell.type === 'chance' || cell.type === 'fate') {
        const list = cell.type === 'chance' ? CHANCE_LIST : FATE_LIST;
        const card = list[Math.floor(Math.random() * list.length)];
        if (!p.isBot) showModal(card.icon, card.title, card.text, async () => {
          await handleMoneyChange(p, card.amount, card.title);
          if (p.money < 0) handleDebt(p, null); else finishTurn();
        }, null, true, "é–‹å§‹ç®—éŒ¢", "");
        else { p.money += card.amount; updateUI(); if (p.money < 0) autoBotLiquidate(p); else finishTurn(); }
      } else finishTurn();
    }

    async function handleMoneyChange(player, amount, reason) {
      if (player.isBot) { player.money += amount; updateUI(); return; }
      return new Promise((resolve) => {
        const old = player.money; const exp = old + amount;
        showMathModal(old, amount, reason, exp, (ans) => {
          if (ans === exp) { player.money = exp; updateUI(); resolve(); }
          else if (ans < exp) { showModal("âš ï¸", "æ•¸å­¸ç®—éŒ¯äº†ï¼", `æ­£ç¢ºæ‡‰ç‚º $${exp.toLocaleString()}ï¼Œä½†ä½ ç®—æˆ $${ans.toLocaleString()}ã€‚<br><br>æˆ‘å€‘ä»¥ä½ çš„ã€ŒéŒ¯èª¤çµæœã€ç‚ºæº–å–”ï¼`, () => { player.money = ans; updateUI(); resolve(); }, null, true, "æ¥å—ä»£åƒ¹"); }
          else showModal("ğŸš«", "ä¸å¯ä»¥å ±å‡å¸³ï¼", `å‰©é¤˜é‡‘é¡ä¸èƒ½æ¯”æ­£ç¢ºçš„é‚„å¤šï¼Œè«‹é‡æ–°æ ¸ç®—èª å¯¦ç”³å ±ã€‚`, () => { handleMoneyChange(player, amount, reason).then(resolve); }, null, true, "é‡æ–°ç®—ä¸€æ¬¡", "");
        });
      });
    }

    function showMathModal(old, change, reason, expected, cb) {
      const m = document.getElementById('modal'); const s = document.getElementById('math-section'); const i = document.getElementById('math-input');
      document.getElementById('modalIcon').innerText = change >= 0 ? "ğŸ’°" : "ğŸ’¸";
      document.getElementById('modalTitle').innerText = "æ•¸å­¸æŒ‘æˆ°æ™‚é–“";
      document.getElementById('modalDesc').innerHTML = `äº‹ä»¶ï¼š<span class="font-bold text-slate-800">${reason}</span>`; s.classList.remove('hidden');
      document.getElementById('math-old').innerText = `$${old.toLocaleString()}`;
      document.getElementById('math-change').innerText = `${change >= 0 ? '+' : ''} $${change.toLocaleString()}`;
      document.getElementById('math-op-label').innerText = change >= 0 ? "è®Šå‹•æ”¶å…¥:" : "è®Šå‹•æ”¯å‡º:"; i.value = "";
      document.getElementById('btnTeacher').onclick = (e) => { e.preventDefault(); i.value = expected; document.getElementById('btnPrimary').click(); };
      document.getElementById('btnPrimary').innerText = "ç¢ºèªæäº¤ç¸½é¡";
      document.getElementById('btnPrimary').onclick = () => { const v = parseInt(i.value); if (isNaN(v)) return; m.classList.add('hidden'); s.classList.add('hidden'); cb(v); };
      document.getElementById('btnSecondary').classList.add('hidden'); m.classList.remove('hidden'); setTimeout(() => i.focus(), 100);
    }

    async function handlePayment(fromP, toIdx, amt) {
      await handleMoneyChange(fromP, -amt, `å‘ ${players[toIdx].name} æ”¯ä»˜æ¬¾é …`);
      if (fromP.money >= 0) { if (toIdx !== null) players[toIdx].money += amt; updateUI(); finishTurn(); }
      else { handleDebt(fromP, toIdx); }
    }

    // --- å‚µå‹™è™•ç†èˆ‡è®Šè³£ ---
    function handleDebt(player, creditorIdx) {
      if (player.money >= 0) { finishTurn(); return; }
      const hasProps = gameState.properties.some(pr => pr.owner === player.id);
      if (!hasProps) { declareBankruptcy(player); return; }

      showModal("ğŸ“‰", "è² å‚µè­¦å‘Š", `ã€${player.name}ã€‘ç›®å‰é¤˜é¡ç‚º $${player.money.toLocaleString()}ã€‚<br>å¿…é ˆè®Šè³£åœŸåœ°é‚„å‚µï¼Œå¦å‰‡ç„¡æ³•ç¹¼çºŒéŠæˆ²ã€‚`, () => {
        openPortfolio(() => {
          if (player.money < 0) handleDebt(player, creditorIdx);
          else {
            showModal("ğŸ’°", "å‚µå‹™æ¸…å„Ÿ", `ã€${player.name}ã€‘å·²ç¶“æ¸…å„Ÿå‚µå‹™ï¼Œå¯ä»¥ç¹¼çºŒç’°å³¶æ—…è¡Œäº†ï¼`, () => finishTurn(), null, true, "å¤ªå¥½äº†");
          }
        }, true);
      }, null, true, "å‰å¾€è³‡ç”¢ç®¡ç†è®Šè³£");
    }

    function autoBotLiquidate(bot) {
      // æ˜ç¢ºé¡¯ç¤ºæ˜¯å“ªä½ç©å®¶æ­£åœ¨è®Šè³£
      showModal("ğŸ’¼", "é›»è…¦è‡ªå‹•ä»£ç®¡", `<b>ã€${bot.name}ã€‘</b>æ­£åœ¨è®Šè³£åä¸‹è³‡ç”¢ä»¥å„Ÿé‚„å‚µå‹™...`, () => {
        // è‡ªå‹•è³£åœ°ç›´åˆ°é¤˜é¡ç‚ºæ­£æˆ–æ²’åœ°å¯è³£
        for (let i = 0; i < gameState.properties.length; i++) {
          if (gameState.properties[i].owner === bot.id) {
            const d = BOARD_DATA[i]; const s = gameState.properties[i];
            const sellP = Math.floor((d.price + (s.level * d.upgrade)) * 0.5);
            bot.money += sellP; gameState.properties[i].owner = null; gameState.properties[i].level = 0;
            if (bot.money >= 0) break;
          }
        }
        updateUI();
        if (bot.money < 0) {
          declareBankruptcy(bot);
        } else {
          // è®Šè³£å®Œæˆå¾Œè‡ªå‹•çµæŸæ­¤å›åˆä¸¦ç¹¼çºŒ
          finishTurn();
        }
      }, null, true, "ç¹¼çºŒåŸ·è¡Œ");
    }

    function openPortfolio(cb = null, mandatory = false) {
      const p = players[gameState.currentTurn]; const my = []; gameState.properties.forEach((pr, i) => { if (pr.owner === p.id) my.push(i); });
      if (my.length === 0) {
        if (mandatory && p.money < 0) { declareBankruptcy(p); }
        else showModal("ğŸšï¸", "ç„¡å¯è®Šç¾è³‡ç”¢", "ä½ ç›®å‰æ²’æœ‰ä»»ä½•åœŸåœ°å¯ä»¥è®Šè³£ã€‚", () => { if (cb) cb(); }, null, true, "æˆ‘çŸ¥é“äº†");
        return;
      }
      const html = my.map(idx => {
        const d = BOARD_DATA[idx]; const s = gameState.properties[idx];
        const sellP = Math.floor((d.price + (s.level * d.upgrade)) * 0.5);
        return `<div class="flex justify-between items-center p-3 border-b border-slate-100"><div class="text-left text-xs font-bold text-slate-700">${d.name} (${LEVEL_NAMES[s.level]})</div><button onclick="sellProperty(${idx}, ${sellP}, ${mandatory ? 'true' : 'false'})" class="bg-red-500 text-white text-[9px] px-2 py-1 rounded-lg font-bold">è³£åœ°æ› $${sellP.toLocaleString()}</button></div>`;
      }).join('');

      const btnText = (mandatory && p.money < 0) ? "ç¹¼çºŒç±ŒéŒ¢ (å°šæ¬  $" + Math.abs(p.money) + ")" : "é—œé–‰ç®¡ç†ä»‹é¢";
      showModal("ğŸ’¼", "è³‡ç”¢è®Šè³£ä¸­å¿ƒ", `<div class="modal-body space-y-2">${html}</div>`, () => { if (cb) cb(); }, null, true, btnText);
    }

    window.sellProperty = async function (idx, p, isDebtFlow) {
      const ownerId = gameState.properties[idx].owner; const plr = players[ownerId];
      document.getElementById('modal').classList.add('hidden');
      await handleMoneyChange(plr, p, `ã€${plr.name}ã€‘è³£å‡ºåœŸåœ° ${BOARD_DATA[idx].name}`);
      gameState.properties[idx].owner = null; gameState.properties[idx].level = 0;
      updateUI();

      if (isDebtFlow === 'true') {
        if (plr.money < 0) openPortfolio(null, true);
        else {
          // è‹¥é‚„æ¸…äº†ï¼Œè·³å› handleDebt çš„å®Œæˆå°è©±æ¡†
          const hasNextBtn = document.querySelector("#modal .modal-body");
          if (hasNextBtn) {
            showModal("ğŸ’°", "å‚µå‹™æ¸…å„Ÿ", `ã€${plr.name}ã€‘å·²ç¶“æ¸…å„Ÿæ‰€æœ‰å‚µå‹™ï¼`, () => finishTurn(), null, true, "å¤ªå¥½äº†");
          }
        }
      } else {
        openPortfolio();
      }
    };

    function declareBankruptcy(p) {
      p.isOut = true; p.money = 0;
      // æ²’æ”¶æ‰€æœ‰åœŸåœ°
      gameState.properties.forEach(pr => { if (pr.owner === p.id) { pr.owner = null; pr.level = 0; } });
      updateUI(); updatePlayerTokens();
      const active = players.filter(pl => !pl.isOut);
      if (active.length <= 1) confirmEndGame(true);
      else showModal("ğŸ’€", "æ­£å¼ç ´ç”¢", `ç©å®¶ <b>ã€${p.name}ã€‘</b> å› ç„¡æ³•å„Ÿé‚„å‚µå‹™ï¼Œæ­£å¼ç ´ç”¢ä¸¦é€€å‡ºæ¯”è³½ï¼`, finishTurn, null, true, "ç¢ºèªå‡ºå±€");
    }

    function confirmEndGame(auto = false) {
      const showRank = () => {
        gameState.gameOver = true;
        const res = players.map(p => {
          let v = 0; gameState.properties.forEach((pr, i) => { if (pr.owner === p.id) v += BOARD_DATA[i].price + (pr.level * BOARD_DATA[i].upgrade); });
          return { name: p.name, color: p.color, out: p.isOut, cash: p.money, assets: v, total: p.isOut ? 0 : p.money + v };
        }).sort((a, b) => b.total - a.total);
        let h = `<div class="modal-body space-y-2 mt-4">`;
        res.forEach((r, i) => h += `<div class="p-3 rounded-xl border-2 ${i === 0 ? 'border-yellow-400 bg-yellow-50' : 'border-slate-100 bg-slate-50'} text-left text-xs"><div class="font-bold flex justify-between" style="color:${r.color}"><span>${i + 1}. ${r.name} ${r.out ? '(å‡ºå±€)' : ''}</span> <span class="text-slate-400">ç¸½å¸‚å€¼: $${r.total.toLocaleString()}</span></div>æ‰‹æŒç¾é‡‘: $${r.cash.toLocaleString()}<br>è³‡ç”¢ä¼°å€¼: $${r.assets.toLocaleString()}</div>`);
        h += `</div>`;
        showModal("ğŸ“Š", "ç’°å³¶å¤§å†’éšªçµç®—è¡¨", h, () => location.reload(), null, true, "å›é¦–é é‡å•ŸæŒ‘æˆ°", "");
      };
      if (auto) showRank(); else showModal("ğŸ†", "çµ‚çµéŠæˆ²", "è¦ç¾åœ¨çµç®—æ‰€æœ‰è²¡ç”¢ä¸¦å®£å‘Šæ’åå—ï¼Ÿ", showRank, null, false, "ç«‹å³çµç®—", "ç¹¼çºŒéŠç©");
    }

    function finishTurn() {
      if (gameState.gameOver) return; gameState.isMoving = false; let c = 0;
      do { gameState.currentTurn = (gameState.currentTurn + 1) % players.length; c++; } while (players[gameState.currentTurn].isOut && c < players.length);
      updateTurnIndicator(); const next = players[gameState.currentTurn]; if (next.isBot && !gameState.gameOver) setTimeout(startTurn, 1000);
    }

    function updateTurnIndicator() {
      const n = players[gameState.currentTurn]; const i = document.getElementById('turn-indicator'); if (i) { i.innerText = `è¼ªåˆ°ï¼š${n.name}`; i.style.color = n.color; }
      players.forEach(p => {
        const b = document.getElementById(`status-bar-${p.id}`);
        if (b) { b.style.transform = p.id === gameState.currentTurn ? "scale(1.1)" : "scale(1)"; b.style.opacity = p.isOut ? "0.2" : "1"; }
        const moneyEl = document.getElementById(`money-${p.id}`);
        if (moneyEl && p.money < 3000) moneyEl.classList.add('money-low'); else if (moneyEl) moneyEl.classList.remove('money-low');
      });
    }

    function updateUI() {
      players.forEach(p => { const el = document.getElementById(`money-${p.id}`); if (el) el.innerText = `$${p.money.toLocaleString()}`; });
      gameState.properties.forEach((pr, i) => {
        const o = document.getElementById(`owner-name-${i}`); const h = document.getElementById(`houses-${i}`);
        if (o) { if (pr.owner !== null) { o.innerText = players[pr.owner].name; o.style.color = players[pr.owner].color; h.innerHTML = Array(pr.level).fill('<div class="house-dot"></div>').join(''); } else { o.innerText = ''; h.innerHTML = ''; } }
      });
    }

    window.confirmReturnToSetup = () => showModal("âš™ï¸", "é‡å•ŸéŠæˆ²", "è¦æ”¾æ£„é€²åº¦é‡å•Ÿå—ï¼Ÿ", () => location.reload(), null, false, "ç¢ºå®šé‡è¨­", "ç•™åœ¨éŠæˆ²");

    function showModal(icon, title, desc, onC, onX, isA, pBT = "ç¢ºå®š", sBT = "å–æ¶ˆ") {
      const m = document.getElementById('modal'); document.getElementById('modalIcon').innerText = icon;
      document.getElementById('modalTitle').innerText = title; document.getElementById('modalDesc').innerHTML = desc;
      document.getElementById('math-section').classList.add('hidden');
      const bP = document.getElementById('btnPrimary'); const bS = document.getElementById('btnSecondary');
      bP.innerText = pBT; bS.innerText = sBT; bS.classList.toggle('hidden', isA);
      bP.onclick = () => { m.classList.add('hidden'); onC(); }; if (!isA) bS.onclick = () => { m.classList.add('hidden'); if (onX) onX(); };
      m.classList.remove('hidden');
    }

    window.onload = renderSetup;
  </script>
</body>

</html>