<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>學校行事曆生成系統</title>
  <!-- 引入核心框架與工具 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

    body {
      font-family: 'Noto+Sans+TC', sans-serif;
      background-color: #f1f5f9;
      color: #334155;
    }

    @media print {

      /* 強制列印時背景為純白，移除灰色底色與陰影 */
      body {
        background-color: white !important;
        -webkit-print-color-adjust: exact;
      }

      .print\:hidden {
        display: none !important;
      }

      .print\:block {
        display: block !important;
      }

      .print\:shadow-none {
        box-shadow: none !important;
      }

      #print-area {
        display: block !important;
        width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
        background-color: white !important;
      }

      @page {
        size: A4;
        margin: 10mm;
      }

      .page-break-month {
        page-break-after: always;
        break-after: page;
        width: 100%;
        height: 275mm;
        display: flex;
        flex-direction: column;
        background: white !important;
        overflow: hidden;
        box-sizing: border-box;
      }

      .page-break-month:last-child {
        page-break-after: auto;
        break-after: auto;
      }

      .report-container {
        width: 100%;
        background: white !important;
      }

      .month-block {
        page-break-inside: avoid;
        break-inside: avoid;
        margin-bottom: 30px;
      }

      .compact-one-page {
        width: 100%;
        height: 275mm;
        background: white !important;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        padding: 5mm;
        box-sizing: border-box;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }

      th,
      td {
        border: 1px solid black !important;
      }
    }

    .dropdown-shadow {
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }

    .custom-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scroll::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    const { useState, useEffect, useMemo, useRef, Fragment } = React;

    // Firebase 核心載入
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // --- 1. 工具函式 ---
    const parseDate = (dateStr) => {
      if (!dateStr) return new Date();
      const [y, m, d] = dateStr.split('-').map(Number);
      return new Date(y, m - 1, d);
    };

    const toLocalDateStr = (date) => {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    };

    const formatDateToShort = (dateStr) => {
      if (!dateStr) return "";
      const d = parseDate(dateStr);
      return `${d.getMonth() + 1}/${d.getDate()}`;
    };

    const isDateInRange = (dStr, start, end) => dStr >= start && dStr <= end;

    const isWeekendDay = (dateStr) => {
      const d = parseDate(dateStr);
      const day = d.getDay();
      return day === 0 || day === 6;
    };

    const getFirebaseConfig = () => {
      try {
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
          return JSON.parse(__firebase_config);
        }
      } catch (e) { }
      return null;
    };

    const config = getFirebaseConfig();
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'school-calendar-external';

    let auth, db;
    if (config) {
      const app = initializeApp(config);
      auth = getAuth(app);
      db = getFirestore(app);
    }

    // --- 2. 組件定義 ---

    const Icon = ({ name, size = 18, className = "" }) => {
      const iconRef = useRef(null);
      useEffect(() => {
        if (window.lucide && iconRef.current) {
          window.lucide.createIcons();
        }
      }, [name]);
      return (
        <span className={`inline-flex items-center justify-center ${className}`} ref={iconRef}>
          <i data-lucide={name} style={{ width: size, height: size }}></i>
        </span>
      );
    };

    const CalendarGrid = ({ y, m, events, headerInfo, weekMap = {}, isMain = false, hideAttendance = false, isSuperCompact = false }) => {
      const firstDay = new Date(y, m, 1).getDay();
      const days = new Date(y, m + 1, 0).getDate();
      const rows = Math.ceil((firstDay + days) / 7);
      let cellHeight = isMain ? 'h-24' : (hideAttendance ? (isSuperCompact ? 'h-[14px]' : 'h-[18px]') : 'h-8');

      const calculateAttendance = () => {
        let count = 0;
        const openingEvent = events.find(e => e.title.includes("開學日"));
        let startLimit = headerInfo.semesterStartDate;
        if (openingEvent && openingEvent.startDate < startLimit) startLimit = openingEvent.startDate;

        for (let d = 1; d <= days; d++) {
          const dStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          if (dStr < startLimit || dStr > headerInfo.semesterEndDate) continue;
          const isHolidayEvent = events.some(e => e.isHoliday && isDateInRange(dStr, e.startDate, e.endDate));
          if (!isWeekendDay(dStr) && !isHolidayEvent) count++;
        }
        return count;
      };

      const getWeekNumber = (row) => {
        const rowSunday = new Date(y, m, 1);
        rowSunday.setDate(1 - rowSunday.getDay() + row * 7);
        const sunStr = toLocalDateStr(rowSunday);
        return (weekMap && weekMap[sunStr]) ? weekMap[sunStr] : "";
      };

      return (
        <div className={`border border-black rounded bg-white text-black ${isMain ? 'p-4' : 'p-0.5'}`}>
          <div className={`font-bold text-center bg-gray-200 border-b border-black mb-0.5 ${isMain ? 'text-xl py-3' : (isSuperCompact ? 'text-[8px] py-0' : 'text-[9px] py-0.5')}`}>{m + 1}月</div>
          <div className={`grid grid-cols-8 text-center font-bold border-b border-black mb-0.5 ${isMain ? 'text-base' : (isSuperCompact ? 'text-[5px]' : 'text-[6px]')}`}>
            <div className="text-blue-700 bg-blue-100 font-bold">週</div>
            <div className="text-red-600 font-bold">日</div>{['一', '二', '三', '四', '五'].map(d => <div key={d}>{d}</div>)}<div className="text-red-600 font-bold">六</div>
          </div>
          <div className="grid grid-cols-8 gap-px bg-gray-400 border border-black">
            {[...Array(rows)].map((_, r) => (
              <Fragment key={`m-${m}-r-${r}`}>
                <div className={`bg-blue-100 flex items-center justify-center font-bold border-r border-gray-300 ${cellHeight} ${isMain ? 'text-sm' : (isSuperCompact ? 'text-[6px]' : 'text-[7px]')}`}>
                  {getWeekNumber(r)}
                </div>
                {[...Array(7)].map((_, c) => {
                  const dNum = r * 7 + c - firstDay + 1;
                  const isValid = dNum > 0 && dNum <= days;
                  const dStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(dNum).padStart(2, '0')}`;
                  const dayEvents = events.filter(e => !e.isMonthOnly && isDateInRange(dStr, e.startDate, e.endDate));
                  const isHoliday = dayEvents.some(e => e.isHoliday);
                  const isImportant = dayEvents.some(e => e.isImportant);
                  const isSatSun = c === 0 || c === 6;

                  let bgClass = "bg-white";
                  let textClass = isSatSun ? "text-red-600 font-bold" : "text-black";

                  if (isHoliday) {
                    bgClass = "bg-red-100";
                    textClass = "text-red-700 font-bold";
                  } else if (isImportant) {
                    bgClass = "bg-green-100";
                    textClass = "text-green-800 font-bold";
                  }

                  return (
                    <div key={`m-${m}-r-${r}-c-${c}`} className={`${bgClass} ${textClass} flex flex-col items-center justify-start border-r border-b border-gray-100 last:border-r-0 ${cellHeight} p-0.5`}>
                      <span className={`${isMain ? 'text-lg' : (isSuperCompact ? 'text-[7px]' : 'text-[8px]')} font-bold`}>{isValid ? dNum : ''}</span>
                      {isMain && isValid && dayEvents.map(e => (
                        <div key={e.id} className={`w-full truncate text-[10px] mt-1 px-1 rounded shadow-sm ${e.isImportant ? 'bg-green-600 text-white font-bold' : (e.isHoliday ? 'bg-red-700 text-white font-bold' : 'bg-white/70 text-slate-700')}`}>
                          {e.title}
                        </div>
                      ))}
                    </div>
                  );
                })}
              </Fragment>
            ))}
          </div>
          {!hideAttendance && (
            <div className={`text-center font-bold text-blue-800 mt-1 border-t border-black pt-0.5 ${isMain ? 'text-sm' : 'text-[7px]'}`}>學生出席天數: {calculateAttendance()}天</div>
          )}
        </div>
      );
    };

    const EventTable = ({ year, monthIdx, events }) => {
      const cols = ["教務處", "學務處", "總務處", "備註"];
      const mEvents = events.filter(e => {
        const dStart = parseDate(e.startDate);
        const dEnd = parseDate(e.endDate);
        const checkDate = new Date(year, monthIdx, 1);
        const checkEnd = new Date(year, monthIdx + 1, 0);
        return (dStart <= checkEnd && dEnd >= checkDate);
      }).sort((a, b) => {
        if (a.isMonthOnly && !b.isMonthOnly) return -1;
        if (!a.isMonthOnly && b.isMonthOnly) return 1;
        return a.startDate.localeCompare(b.startDate);
      });

      return (
        <table className="w-full border-collapse border border-black text-[11px] text-black">
          <thead><tr className="bg-gray-200 font-bold text-black">{cols.map(c => <th key={c} className="border border-black p-1.5 w-1/4 text-center">{c}</th>)}</tr></thead>
          <tbody>
            <tr>
              {cols.map((dept, c) => {
                const deptEvents = mEvents.filter(ev => ev.tag === dept);
                return (
                  <td key={`td-${year}-${monthIdx}-${c}`} className="border border-black p-2 align-top h-40 bg-white text-black">
                    {deptEvents.length > 0 ? deptEvents.map((e, idx) => {
                      const dateStr = e.isMonthOnly ? "(待定)" : (e.startDate === e.endDate ? formatDateToShort(e.startDate) : `${formatDateToShort(e.startDate)}~${formatDateToShort(e.endDate)}`);
                      let textColor = "text-black";
                      if (e.isHoliday) textColor = "text-red-600 font-bold";
                      else if (e.isImportant) textColor = "text-green-700 font-bold";

                      return (
                        <div key={idx} className={`${textColor} mb-1 leading-tight`}>
                          <span className="inline-block bg-slate-100 rounded px-1 text-[8px] mr-1 text-slate-500 font-bold">{dateStr}</span>
                          {e.title}
                        </div>
                      );
                    }) : null}
                  </td>
                );
              })}
            </tr>
          </tbody>
        </table>
      );
    };

    const MonthEventList = ({ events, year, monthIdx, isSuperCompact = false }) => {
      const mEvents = events.filter(e => {
        const dStart = parseDate(e.startDate);
        const dEnd = parseDate(e.endDate);
        const checkDate = new Date(year, monthIdx, 1);
        const checkEnd = new Date(year, monthIdx + 1, 0);
        return (dStart <= checkEnd && dEnd >= checkDate);
      }).sort((a, b) => {
        if (a.isMonthOnly && !b.isMonthOnly) return -1;
        if (!a.isMonthOnly && b.isMonthOnly) return 1;
        return a.startDate.localeCompare(b.startDate);
      });

      return (
        <div className={`flex flex-col ${isSuperCompact ? 'gap-0' : 'gap-0.5'} text-black`}>
          {mEvents.map((e, idx) => {
            const isWeekend = !e.isMonthOnly && isWeekendDay(e.startDate);
            const dateDisplay = e.isMonthOnly ? "(待定)" : (e.startDate === e.endDate ? formatDateToShort(e.startDate) : `${formatDateToShort(e.startDate)}-${formatDateToShort(e.endDate)}`);

            let textColor = "text-slate-700";
            if (e.isHoliday || isWeekend) textColor = "text-red-600 font-bold";
            else if (e.isImportant) textColor = "text-green-700 font-bold";
            if (e.isMonthOnly) textColor = "text-blue-600 font-bold";

            return (
              <div key={idx} className={`${textColor} ${isSuperCompact ? 'text-[9px]' : 'text-[10px]'} flex items-start gap-2 leading-tight`}>
                <span className="font-mono font-medium whitespace-nowrap min-w-[35px]">{dateDisplay}</span>
                <span className="flex-1 truncate">{e.title}</span>
              </div>
            );
          })}
          {mEvents.length === 0 && <div className="text-[9px] text-slate-300 italic py-0.5">本月無特殊行事</div>}
        </div>
      );
    };

    const PreviewContent = ({ mode, semesterRange, headerInfo, events, weekMap = {}, fullTitle, simplifiedTitle }) => {
      const isManyMonths = semesterRange.length >= 6;
      return (
        <div className={`bg-white mx-auto print:shadow-none shadow-2xl relative text-black ${mode === 'compact' ? 'compact-one-page' : 'p-14 w-[210mm]'}`}>
          {mode === 'compact' && (
            <div className="flex flex-col h-full text-black px-6 py-4">
              <div className={`text-center border-b-2 border-black relative text-black ${isManyMonths ? 'mb-2 pb-2' : 'mb-5 pb-4'}`}>
                <h1 className={`${isManyMonths ? 'text-2xl' : 'text-3xl'} font-bold tracking-[0.3em] uppercase text-black`}>{headerInfo.schoolName}</h1>
                <div className={`${isManyMonths ? 'text-base' : 'text-lg'} font-bold mt-1 text-slate-800 tracking-widest`}>
                  {headerInfo.academicYear} 學年度 {headerInfo.semester}
                </div>
                <div className={`${isManyMonths ? 'text-xs' : 'text-sm'} font-medium mt-0.5 text-slate-500 tracking-widest text-black`}>重要行事一覽表</div>
                <div className="absolute right-0 bottom-1 text-[8px] text-slate-400">更新時間：{headerInfo.version}</div>
              </div>
              <div className="flex-1 flex flex-col min-h-0 overflow-hidden">
                {semesterRange.map((item, idx) => (
                  <div key={idx} className={`grid grid-cols-12 gap-6 items-start border-b border-slate-100 last:border-0 flex-1 min-h-0 ${isManyMonths ? 'py-1' : 'pb-3 mb-1'}`}>
                    <div className="col-span-4 h-full flex flex-col justify-center">
                      <CalendarGrid y={item.year} m={item.month} events={events} headerInfo={headerInfo} weekMap={weekMap} isMain={false} hideAttendance={true} isSuperCompact={isManyMonths} />
                    </div>
                    <div className="col-span-8 flex flex-col justify-start h-full pt-2">
                      <MonthEventList events={events} year={item.year} monthIdx={item.month} isSuperCompact={isManyMonths} />
                    </div>
                  </div>
                ))}
              </div>
              <div className="mt-2 border-t border-slate-100 pt-2 flex justify-end items-center text-[9px] text-slate-400 italic">
                <span>{headerInfo.academicYear} 學年度 {headerInfo.semester}</span>
              </div>
            </div>
          )}

          {mode === 'report' && (
            <div className="flex flex-col text-black">
              <div className="flex justify-between items-start mb-12 border-b-2 border-black pb-4 gap-6 text-black">
                <h1 className="text-2xl font-bold leading-normal flex-1 tracking-widest text-black">{fullTitle}</h1>
                <div className="text-sm font-bold whitespace-nowrap border-2 border-black px-2 py-1 text-black">{headerInfo.version}</div>
              </div>
              {semesterRange.map((item, idx) => (
                <div key={idx} className="month-block mb-10 text-black">
                  <div className="grid grid-cols-12 gap-8 items-start text-black">
                    <div className="col-span-3 text-black">
                      <CalendarGrid y={item.year} m={item.month} events={events} headerInfo={headerInfo} weekMap={weekMap} isMain={false} hideAttendance={false} />
                    </div>
                    <div className="col-span-9 text-black">
                      <EventTable year={item.year} monthIdx={item.month} events={events} />
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}

          {mode === 'calendar' && (
            <div className="flex flex-col text-black">
              {semesterRange.map((item, idx) => (
                <div key={idx} className="page-break-month text-black px-8 py-6">
                  <div className="flex justify-between items-start mb-6 border-b-2 border-black pb-3 gap-6 text-black">
                    <h1 className="text-2xl font-bold leading-normal flex-1 tracking-widest text-black">{simplifiedTitle}</h1>
                    <div className="text-sm font-bold border-2 border-black px-2 py-1 text-black">{headerInfo.version}</div>
                  </div>
                  <div className="flex-1 text-black flex flex-col justify-start">
                    <CalendarGrid y={item.year} m={item.month} events={events} headerInfo={headerInfo} weekMap={weekMap} isMain={true} hideAttendance={false} />
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    };

    const App = () => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(!!config);
      const [events, setEvents] = useState([]);
      const [printMode, setPrintMode] = useState('report');
      const [showPreview, setShowPreview] = useState(false);
      const [showExportMenu, setShowExportMenu] = useState(false);

      const [newEvent, setNewEvent] = useState({
        startDate: toLocalDateStr(new Date()),
        endDate: toLocalDateStr(new Date()),
        title: '',
        tag: '教務處',
        isHoliday: false,
        isImportant: false,
        isMonthOnly: false
      });

      const [headerInfo, setHeaderInfo] = useState({
        schoolName: "OO市OO區OO國民小學",
        academicYear: "114",
        semester: "第二學期",
        version: "115.01.20版",
        semesterStartDate: "2026-02-23",
        semesterEndDate: "2026-06-30",
        startWeekNumber: "1"
      });

      const menuRef = useRef(null);
      const fileInputRef = useRef(null);

      const weekMap = useMemo(() => {
        const map = {};
        const start = parseDate(headerInfo.semesterStartDate);
        const end = parseDate(headerInfo.semesterEndDate);
        const currentSun = new Date(start);
        currentSun.setDate(start.getDate() - start.getDay());

        let weekCounter = parseInt(headerInfo.startWeekNumber) || 1;

        while (currentSun <= end) {
          let hasSchoolDay = false;
          for (let i = 1; i <= 5; i++) {
            const checkDay = new Date(currentSun);
            checkDay.setDate(currentSun.getDate() + i);
            const dStr = toLocalDateStr(checkDay);
            if (dStr >= headerInfo.semesterStartDate && dStr <= headerInfo.semesterEndDate) {
              const isHoliday = events.some(e => e.isHoliday && isDateInRange(dStr, e.startDate, e.endDate));
              if (!isHoliday) { hasSchoolDay = true; break; }
            }
          }
          const sunStr = toLocalDateStr(currentSun);
          if (hasSchoolDay) map[sunStr] = weekCounter++;
          else map[sunStr] = "";
          currentSun.setDate(currentSun.getDate() + 7);
        }
        return map;
      }, [headerInfo.semesterStartDate, headerInfo.semesterEndDate, headerInfo.startWeekNumber, events]);

      const semesterRange = useMemo(() => {
        const start = parseDate(headerInfo.semesterStartDate);
        const end = parseDate(headerInfo.semesterEndDate);
        const result = [];
        let current = new Date(start.getFullYear(), start.getMonth(), 1);
        while (current <= end) {
          result.push({ year: current.getFullYear(), month: current.getMonth() });
          current.setMonth(current.getMonth() + 1);
        }
        return result;
      }, [headerInfo.semesterStartDate, headerInfo.semesterEndDate]);

      const formatHeaderDate = (dateStr) => {
        if (!dateStr) return "";
        const parts = dateStr.split('-');
        return `${headerInfo.academicYear}.${parts[1]}.${parts[2]}`;
      };

      const fullTitle = `${headerInfo.schoolName}${headerInfo.academicYear}學年度${headerInfo.semester}行事曆 (${formatHeaderDate(headerInfo.semesterStartDate)}-${formatHeaderDate(headerInfo.semesterEndDate)})`;
      const simplifiedTitle = `${headerInfo.schoolName}行事曆`;

      useEffect(() => {
        if (!config) { setLoading(false); return; }
        const initAuth = async () => {
          try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
              await signInWithCustomToken(auth, __initial_auth_token);
            } else { await signInAnonymously(auth); }
          } catch (e) { setLoading(false); }
        };
        initAuth();
        return onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); });
      }, []);

      useEffect(() => {
        if (!user || !db) return;
        const configDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'config', 'header');
        getDoc(configDocRef).then((snap) => { if (snap.exists()) setHeaderInfo(snap.data()); });
        const eventsColRef = collection(db, 'artifacts', appId, 'users', user.uid, 'events');
        const unsubscribe = onSnapshot(eventsColRef, (snapshot) => {
          setEvents(snapshot.docs.map(d => ({ ...d.data(), id: d.id })));
        });
        const handleClickOutside = (e) => { if (menuRef.current && !menuRef.current.contains(e.target)) setShowExportMenu(false); };
        document.addEventListener("mousedown", handleClickOutside);
        return () => { unsubscribe(); document.removeEventListener("mousedown", handleClickOutside); };
      }, [user]);

      const saveHeaderInfo = (newInfo) => {
        setHeaderInfo(newInfo);
        if (user && db) {
          const configDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'config', 'header');
          setDoc(configDocRef, newInfo);
        }
      };

      const handleAddEvent = async (e) => {
        e.preventDefault();
        if (!newEvent.title) return;

        let dataToSave = { ...newEvent };
        if (newEvent.isMonthOnly) {
          const d = parseDate(newEvent.startDate);
          const firstDay = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-01`;
          dataToSave.startDate = firstDay; dataToSave.endDate = firstDay;
        } else {
          dataToSave.endDate = newEvent.endDate < newEvent.startDate ? newEvent.startDate : newEvent.endDate;
        }

        if (user && db) {
          const eventsColRef = collection(db, 'artifacts', appId, 'users', user.uid, 'events');
          await addDoc(eventsColRef, dataToSave);
        } else {
          setEvents(prev => [...prev, { ...dataToSave, id: Date.now() }]);
        }
        setNewEvent({ ...newEvent, title: '', isHoliday: false, isImportant: false, isMonthOnly: false });
      };

      const handleDeleteEvent = async (id) => {
        if (user && db) { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'events', id)); }
        else { setEvents(prev => prev.filter(e => e.id !== id)); }
      };

      const handleImport = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (event) => {
          try {
            const importedData = JSON.parse(event.target.result);
            if (Array.isArray(importedData)) {
              const cleaned = importedData.map(item => ({
                startDate: item.startDate || item.date || "",
                endDate: item.endDate || item.startDate || item.date || "",
                title: item.title || "",
                tag: item.tag || "教務處",
                isHoliday: !!item.isHoliday,
                isImportant: !!item.isImportant,
                isMonthOnly: !!item.isMonthOnly
              })).filter(item => item.title && item.startDate);
              if (user && db) {
                const eventsColRef = collection(db, 'artifacts', appId, 'users', user.uid, 'events');
                for (const item of cleaned) { await addDoc(eventsColRef, item); }
              } else {
                setEvents(prev => [...prev, ...cleaned.map(d => ({ ...d, id: Date.now() + Math.random() }))]);
              }
            }
          } catch (err) { }
          if (fileInputRef.current) fileInputRef.current.value = "";
        };
        reader.readAsText(file);
      };

      const triggerPrint = (mode) => {
        setPrintMode(mode); setShowPreview(false);
        setTimeout(() => window.print(), 300);
      };

      const exportWordList = () => {
        const sorted = [...events].sort((a, b) => a.startDate.localeCompare(b.startDate));
        const table = `<table border="1" style="border-collapse:collapse;width:100%;"><thead><tr style="background:#f1f5f9;"><th>日期</th><th>處室</th><th>事項</th></tr></thead><tbody>${sorted.map(e => `<tr><td>${e.isMonthOnly ? '(待定)' : formatDateToShort(e.startDate)}</td><td>${e.tag}</td><td>${e.title}</td></tr>`).join('')}</tbody></table>`;
        const html = `<html><head><meta charset="utf-8"></head><body><h2>${fullTitle}</h2>${table}</body></html>`;
        const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob); link.download = `${headerInfo.schoolName}_行事清單.doc`; link.click();
      };

      const exportJSON = () => {
        const blob = new Blob([JSON.stringify(events, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob); link.download = `${headerInfo.schoolName}_備份.json`; link.click();
      };

      const exportICS = () => {
        const sortedEvents = [...events].filter(e => !e.isMonthOnly).sort((a, b) => a.startDate.localeCompare(b.startDate));
        let ics = ['BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//School//EN', 'METHOD:PUBLISH'];
        sortedEvents.forEach(e => {
          const start = e.startDate.replace(/-/g, '');
          const endDateObj = parseDate(e.endDate); endDateObj.setDate(endDateObj.getDate() + 1);
          const end = toLocalDateStr(endDateObj).replace(/-/g, '');
          ics.push('BEGIN:VEVENT', `DTSTART;VALUE=DATE:${start}`, `DTEND;VALUE=DATE:${end}`, `SUMMARY:${e.title}`, 'END:VEVENT');
        });
        ics.push('END:VCALENDAR');
        const link = document.createElement('a');
        link.href = URL.createObjectURL(new Blob([ics.join('\r\n')], { type: 'text/calendar' }));
        link.download = `${headerInfo.schoolName}.ics`; link.click();
      };

      if (loading) return <div className="h-screen flex flex-col items-center justify-center font-bold text-slate-500"><Icon name="loader-2" className="animate-spin mb-2" size={32} />資料同步中...</div>;

      return (
        <div className="min-h-screen text-black">
          <nav className="bg-white border-b sticky top-0 z-30 px-6 py-4 flex justify-between items-center print:hidden shadow-sm">
            <div className="flex items-center gap-3">
              <Icon name="calendar" className="text-blue-600" size={24} />
              <h1 className="text-xl font-bold text-slate-700">學校行事曆生成系統</h1>
            </div>
            <div className="flex gap-2">
              <div className="relative" ref={menuRef}>
                <button onClick={() => setShowExportMenu(!showExportMenu)} className="flex items-center gap-2 px-4 py-2 border border-slate-200 rounded-lg bg-white text-slate-600 font-bold hover:bg-slate-50 shadow-sm transition-all text-black">
                  <Icon name="share-2" /> 預覽與匯出 <Icon name="chevron-down" size={14} />
                </button>
                {showExportMenu && (
                  <div className="absolute right-0 mt-2 w-80 bg-white border border-slate-200 rounded-xl dropdown-shadow py-2 z-50 overflow-hidden text-sm">
                    <button onClick={() => { setPrintMode('report'); setShowPreview(true); setShowExportMenu(false); }} className="w-full text-left px-4 py-3 hover:bg-blue-50 flex items-center gap-3 font-bold transition-colors text-blue-600 text-black"><Icon name="eye" />PDF 行政報表預覽</button>
                    <button onClick={() => { setPrintMode('compact'); setShowPreview(true); setShowExportMenu(false); }} className="w-full text-left px-4 py-3 hover:bg-blue-50 flex items-center gap-3 font-bold transition-colors text-orange-600 text-black"><Icon name="file-text" />PDF 一頁重要行事簡曆</button>
                    <button onClick={() => { setPrintMode('calendar'); setShowPreview(true); setShowExportMenu(false); }} className="w-full text-left px-4 py-3 hover:bg-blue-50 flex items-center gap-3 font-bold transition-colors text-purple-600 text-black"><Icon name="calendar-days" />PDF 月曆預覽 (一月一頁)</button>
                    <div className="border-t my-1"></div>
                    <button onClick={() => { exportWordList(); setShowExportMenu(false); }} className="w-full text-left px-4 py-3 hover:bg-blue-50 flex items-center gap-3 transition-colors text-slate-600 font-bold text-black"><Icon name="list" className="text-slate-500" />下載 Word 版行事清單</button>
                    <button onClick={() => { exportICS(); setShowExportMenu(false); }} className="w-full text-left px-4 py-3 hover:bg-blue-50 flex items-center gap-3 font-bold text-blue-600 transition-colors text-black"><Icon name="calendar-range" />Google 日曆匯出 (.ics)</button>
                    <button onClick={() => { exportJSON(); setShowExportMenu(false); }} className="w-full text-left px-4 py-3 hover:bg-blue-50 flex items-center gap-3 transition-colors text-slate-600 font-medium text-black"><Icon name="save" className="text-amber-500" />備份資料 (JSON)</button>
                  </div>
                )}
              </div>
              <button onClick={() => { setPrintMode('report'); setShowPreview(true); }} className="px-5 py-2 bg-slate-800 text-white rounded-lg font-bold shadow-md hover:bg-slate-900 active:scale-95 flex items-center gap-2 transition-all text-white">
                <Icon name="eye" size={16} /> PDF 行政報表預覽
              </button>
            </div>
          </nav>

          <main className="max-w-6xl mx-auto p-6 flex flex-col gap-10 print:hidden">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              {/* 1. 設定區域 */}
              <section className="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 flex flex-col space-y-5 h-full">
                <div className="flex items-center gap-3 border-b pb-4"><div className="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center text-slate-500"><Icon name="settings" size={20} /></div><h3 className="font-bold text-lg">1. 學期基礎設定</h3></div>
                <div className="space-y-4 text-sm">
                  <div className="flex flex-col gap-1"><label className="text-xs font-bold text-slate-400 ml-1">學校全銜</label><input className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-100 outline-none text-black font-bold" value={headerInfo.schoolName} onChange={e => saveHeaderInfo({ ...headerInfo, schoolName: e.target.value })} /></div>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="flex flex-col gap-1"><label className="text-xs font-bold text-slate-400 ml-1">學年度</label><input className="p-2.5 bg-slate-50 border border-slate-200 rounded-lg w-full outline-none text-black font-bold" value={headerInfo.academicYear} onChange={e => saveHeaderInfo({ ...headerInfo, academicYear: e.target.value })} /></div>
                    <div className="flex flex-col gap-1"><label className="text-xs font-bold text-slate-400 ml-1">學期</label><input className="p-2.5 bg-slate-50 border border-slate-200 rounded-lg w-full outline-none text-black font-bold" value={headerInfo.semester} onChange={e => saveHeaderInfo({ ...headerInfo, semester: e.target.value })} /></div>
                  </div>
                  <div className="grid grid-cols-3 gap-4 text-xs font-bold text-slate-400">
                    <div className="flex flex-col gap-1">起始日期<input type="date" className="w-full p-2.5 bg-slate-50 border border-blue-100 rounded-lg mt-1 text-black font-normal outline-none font-bold" value={headerInfo.semesterStartDate} onChange={e => saveHeaderInfo({ ...headerInfo, semesterStartDate: e.target.value })} /></div>
                    <div className="flex flex-col gap-1">結束日期<input type="date" className="w-full p-2.5 bg-slate-50 border border-blue-100 rounded-lg mt-1 text-black font-normal outline-none font-bold" value={headerInfo.semesterEndDate} onChange={e => saveHeaderInfo({ ...headerInfo, semesterEndDate: e.target.value })} /></div>
                    <div className="flex flex-col gap-1">起始週次<input type="number" min="1" className="w-full p-2.5 bg-blue-50 border border-blue-200 rounded-lg mt-1 text-blue-700 font-bold outline-none" value={headerInfo.startWeekNumber} onChange={e => saveHeaderInfo({ ...headerInfo, startWeekNumber: e.target.value })} /></div>
                  </div>
                  <div className="flex flex-col gap-1"><label className="text-xs font-bold text-slate-400 ml-1">版本更新時間 (顯示在 PDF 右上角)</label><input className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg outline-none text-black font-bold" value={headerInfo.version} onChange={e => saveHeaderInfo({ ...headerInfo, version: e.target.value })} /></div>
                </div>
              </section>

              {/* 2. 新增區域 */}
              <section className="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 flex flex-col space-y-5 h-full">
                <div className="flex items-center gap-3 border-b pb-4"><div className="w-10 h-10 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600"><Icon name="plus" size={20} /></div><h3 className="font-bold text-lg text-blue-600">2. 新增行事事項</h3></div>
                <form onSubmit={handleAddEvent} className="space-y-4 text-black">
                  <div className="grid grid-cols-2 gap-4">
                    <div className="flex flex-col gap-1">
                      <label className="text-xs font-bold text-slate-400 ml-1">{newEvent.isMonthOnly ? "選擇月份" : "開始日期"}</label>
                      <input type="date" className="w-full p-2.5 border border-slate-200 rounded-lg bg-slate-50 text-sm outline-none focus:ring-2 focus:ring-blue-100 text-black font-bold" value={newEvent.startDate} onChange={e => setNewEvent({ ...newEvent, startDate: e.target.value, endDate: e.target.value })} />
                    </div>
                    {!newEvent.isMonthOnly && (
                      <div className="flex flex-col gap-1"><label className="text-xs font-bold text-slate-400 ml-1">至結束日期</label><input type="date" className="w-full p-2.5 border border-slate-200 rounded-lg bg-slate-50 text-sm outline-none focus:ring-2 focus:ring-blue-100 text-black font-bold" value={newEvent.endDate} onChange={e => setNewEvent({ ...newEvent, endDate: e.target.value })} /></div>
                    )}
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="flex flex-col gap-1 col-span-2 sm:col-span-1">
                      <label className="text-xs font-bold text-slate-400 ml-1">事項標題</label>
                      <input className="w-full p-2.5 border border-slate-300 rounded-lg font-bold bg-white outline-none focus:ring-2 focus:ring-blue-100 text-black" value={newEvent.title} onChange={e => setNewEvent({ ...newEvent, title: e.target.value })} placeholder="例如：校慶" />
                    </div>
                    <div className="flex flex-col gap-1 col-span-2 sm:col-span-1">
                      <label className="text-xs font-bold text-slate-400 ml-1">處室分類</label>
                      <select className="w-full p-2.5 border border-slate-300 rounded-lg font-bold bg-slate-50 outline-none focus:ring-2 focus:ring-blue-100 text-black" value={newEvent.tag} onChange={e => setNewEvent({ ...newEvent, tag: e.target.value })}>
                        <option>教務處</option><option>學務處</option><option>總務處</option><option>備註</option>
                      </select>
                    </div>
                  </div>

                  <div className="flex flex-col gap-2 pt-1">
                    <label className="flex items-center gap-3 cursor-pointer p-3 bg-blue-50 rounded-xl border border-blue-100 text-sm font-bold text-blue-700 hover:bg-blue-100 transition-colors">
                      <input type="checkbox" className="w-5 h-5 accent-blue-600 text-black" checked={newEvent.isMonthOnly} onChange={e => setNewEvent({ ...newEvent, isMonthOnly: e.target.checked })} />
                      <span>僅限月份 (日期未定，標記為待定)</span>
                    </label>
                    <label className="flex items-center gap-3 cursor-pointer p-3 bg-red-50 rounded-xl border border-red-100 text-sm font-bold text-red-700 hover:bg-red-100 transition-colors"><input type="checkbox" className="w-5 h-5 accent-red-600 text-black" checked={newEvent.isHoliday} onChange={e => setNewEvent({ ...newEvent, isHoliday: e.target.checked, isImportant: false })} /><span>標記為放假日 (計算出席天數會扣除)</span></label>
                    <label className="flex items-center gap-3 cursor-pointer p-3 bg-green-50 rounded-xl border border-green-100 text-sm font-bold text-green-700 hover:bg-green-100 transition-colors"><input type="checkbox" className="w-5 h-5 accent-green-600 text-black" checked={newEvent.isImportant} onChange={e => setNewEvent({ ...newEvent, isImportant: e.target.checked, isHoliday: false })} /><span>標記為重要事項</span></label>
                  </div>

                  <button className="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition-all flex items-center justify-center gap-2 text-lg">確認加入行事清單</button>
                </form>
              </section>
            </div>

            <div className="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden flex flex-col mb-10 text-black">
              <div className="p-6 border-b bg-slate-50 flex justify-between items-center text-black">
                <div className="flex items-center gap-3"><div className="w-8 h-8 bg-slate-200 rounded-lg flex items-center justify-center text-slate-600 font-bold text-xs">{events.length}</div><h3 className="font-bold text-slate-700 text-lg">已登錄學期行事完整清單</h3></div>
                <div className="flex items-center gap-3">
                  <input type="file" className="hidden" ref={fileInputRef} accept=".json" onChange={handleImport} /><button onClick={() => fileInputRef.current.click()} className="px-4 py-2 border border-slate-300 rounded-lg text-sm font-bold hover:bg-white flex items-center gap-2 transition-all shadow-sm text-black"><Icon name="upload" size={14} /> 匯入備份</button>
                </div>
              </div>
              <div className="divide-y max-h-[600px] overflow-y-auto custom-scroll">
                {events.sort((a, b) => a.startDate.localeCompare(b.startDate)).map(e => (
                  <div key={e.id} className={`p-4 sm:px-8 flex flex-wrap justify-between items-center hover:bg-slate-50 transition-colors group ${e.isImportant ? 'bg-green-50/20' : ''}`}>
                    <div className="flex flex-wrap gap-4 items-center">
                      <div className="flex flex-col w-32 font-bold">
                        {e.isMonthOnly ? (
                          <span className="text-[11px] font-bold text-blue-500">待定 ({e.startDate.substring(0, 7)})</span>
                        ) : (
                          <Fragment>
                            <span className="text-[11px] font-mono text-slate-400">{e.startDate}</span>
                            {e.startDate !== e.endDate && <span className="text-[9px] text-blue-400">至 {e.endDate}</span>}
                          </Fragment>
                        )}
                      </div>
                      <span className={`text-[10px] px-2 py-0.5 rounded-full border font-bold ${e.isImportant ? 'text-green-600 border-green-200 bg-green-50' : (e.isHoliday ? 'text-red-600 border-red-200 bg-red-50' : 'text-slate-500 bg-white shadow-sm')}`}>{e.tag}</span>
                      <span className={`font-bold text-base ${e.isHoliday ? 'text-red-500' : (e.isImportant ? 'text-green-700' : (isWeekendDay(e.startDate) && !e.isMonthOnly ? 'text-red-500' : 'text-slate-700'))}`}>
                        {e.title}
                      </span>
                    </div>
                    <button onClick={() => handleDeleteEvent(e.id)} className="p-3 text-red-500 hover:bg-red-50 rounded-full transition-all opacity-0 group-hover:opacity-100 flex items-center justify-center shadow-sm text-red-500"><Icon name="trash-2" size={20} /></button>
                  </div>
                ))}
              </div>
            </div>
          </main>

          {showPreview && (
            <div className="fixed inset-0 bg-slate-900/95 backdrop-blur-sm z-50 flex items-center justify-center p-4 print:hidden">
              <div className="bg-white w-full max-w-5xl max-h-[95vh] rounded-3xl shadow-2xl overflow-hidden flex flex-col">
                <div className="p-6 border-b flex justify-between bg-slate-100 font-bold text-slate-700 items-center">
                  <span className="flex items-center gap-3 text-blue-600 text-lg font-bold"><Icon name="eye" size={24} /> PDF 預覽：{printMode === 'compact' ? '一頁重要行事簡曆' : (printMode === 'calendar' ? '月曆預覽' : '行政報表')}</span>
                  <button onClick={() => setShowPreview(false)} className="hover:bg-red-100 hover:text-red-600 rounded-full p-2 transition-all"><Icon name="x" size={24} /></button>
                </div>
                <div className="flex-1 overflow-y-auto p-12 bg-slate-300">
                  <div className="flex flex-col gap-10 items-center">
                    <PreviewContent mode={printMode} semesterRange={semesterRange} headerInfo={headerInfo} events={events} weekMap={weekMap} fullTitle={fullTitle} simplifiedTitle={simplifiedTitle} />
                  </div>
                </div>
                <div className="p-6 border-t bg-white flex justify-end gap-4 font-bold shadow-top">
                  <button onClick={() => setShowPreview(false)} className="px-10 py-3 border-2 border-slate-200 rounded-2xl font-bold text-slate-500 hover:bg-slate-50">返回編輯</button>
                  <button onClick={() => triggerPrint(printMode)} className="px-10 py-3 bg-blue-600 text-white rounded-2xl shadow-xl hover:bg-blue-700 active:scale-95 transition-all flex items-center gap-3 font-bold text-white"><Icon name="printer" size={20} /> 確認列印 / 下載 PDF</button>
                </div>
              </div>
            </div>
          )}

          <div id="print-area" className="hidden print:block bg-white text-black p-0">
            {printMode === 'compact' ? (
              <div className="compact-one-page">
                <PreviewContent mode="compact" semesterRange={semesterRange} headerInfo={headerInfo} events={events} weekMap={weekMap} fullTitle={fullTitle} simplifiedTitle={simplifiedTitle} />
              </div>
            ) : printMode === 'calendar' ? (
              semesterRange.map((item, idx) => (
                <div key={`calendar-${idx}`} className="page-break-month">
                  <PreviewContent mode="calendar" semesterRange={[item]} headerInfo={headerInfo} events={events} weekMap={weekMap} fullTitle={fullTitle} simplifiedTitle={simplifiedTitle} />
                </div>
              ))
            ) : (
              <div className="report-container">
                <PreviewContent mode="report" semesterRange={semesterRange} headerInfo={headerInfo} events={events} weekMap={weekMap} fullTitle={fullTitle} simplifiedTitle={simplifiedTitle} />
              </div>
            )}
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>