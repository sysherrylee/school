<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>國小排課系統 - 穩定功能版</title>
  <!-- 載入核心庫 -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');

    body {
      font-family: 'Noto Sans TC', sans-serif;
      letter-spacing: -0.01em;
      font-weight: 900;
    }

    @media print {
      .print-hidden {
        display: none !important;
      }

      body {
        background: white !important;
        padding: 0 !important;
      }

      #timetable-container {
        min-width: 100% !important;
        border: none !important;
      }
    }

    .custom-scroll::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    .custom-scroll::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-scroll::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }

    .fixed-table {
      table-layout: fixed;
      width: 100%;
      min-width: 1000px;
      border-collapse: collapse;
    }

    .fixed-table th,
    .fixed-table td {
      width: 16.66%;
      text-align: center;
      vertical-align: middle;
      padding: 10px 4px;
    }

    .lesson-cell {
      transition: all 0.2s ease;
      cursor: pointer;
      border-radius: 32px;
    }

    .lesson-cell:hover {
      transform: translateY(-2px);
      z-index: 10;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .lesson-cell:active {
      transform: translateY(0);
      scale: 0.98;
    }

    @keyframes pulse-red {
      0% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }

    .overlap-warning {
      animation: pulse-red 2s infinite;
    }
  </style>
</head>

<body class="bg-[#F1F5F9]">
  <div id="root"></div>

  <script type="text/babel">
    const DAYS = ["週一", "週二", "週三", "週四", "週五"];
    const TIMES = [
      { id: 1, period: "第一節", time: "08:40-09:20" },
      { id: 2, period: "第二節", time: "09:30-10:10" },
      { id: 3, period: "第三節", time: "10:30-11:10" },
      { id: 4, period: "第四節", time: "11:20-12:00" },
      { id: 5, period: "第五節", time: "13:30-14:10" },
      { id: 6, period: "第六節", time: "14:20-15:00" },
      { id: 7, period: "第七節", time: "15:20-16:00" },
    ];

    // 圖示組件定義
    const IconSchool = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></svg>;
    const IconBell = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" /><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" /></svg>;
    const IconEdit = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></svg>;
    const IconSave = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></svg>;
    const IconX = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>;
    const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>;
    const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 1 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1-2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 1 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></svg>;
    const IconChart = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10" /><line x1="12" y1="20" x2="12" y2="4" /><line x1="6" y1="20" x2="6" y2="14" /></svg>;
    const IconPrint = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></svg>;
    const IconFile = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" y1="13" x2="8" y2="13" /><line x1="16" y1="17" x2="8" y2="17" /><polyline points="10 9 9 9 8 9" /></svg>;
    const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></svg>;
    const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12" /></svg>;
    const IconSync = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6" /><path d="M2 12c0-4.4 3.6-8 8-8 3.3 0 6.2 2 7.4 4.9M22 12c0 4.4-3.6 8-8 8-3.3 0-6.2-2-7.4-4.9" /></svg>;
    const IconEraser = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21" /><path d="m22 21H7" /><path d="m5 11 9 9" /></svg>;
    const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>;
    const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></svg>;
    const IconEye = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" /><circle cx="12" cy="12" r="3" /></svg>;

    const INITIAL_DATA = [
      { className: "一年甲班", homeroomTeacher: "盧佩雯老師", schedule: { "週一": [{ s: "彈性(英語)", t: "葉佩綺老師" }, { s: "數學", t: "盧佩雯老師" }, { s: "生活(音樂)", t: "許蓓宜老師" }, { s: "國語", t: "盧佩雯老師" }, null, null, null], "週二": [{ s: "體育", t: "盧佩雯老師" }, { s: "本土語", t: "陳香蘭老師", isManualShared: true }, { s: "彈性(英語)", t: "葉佩綺老師" }, { s: "健康", t: "洪瑄妙老師" }, { s: "國語", t: "盧佩雯老師" }, { s: "國語", t: "盧佩雯老師" }, { s: "彈性(漁鄉)", t: "盧佩雯老師" }], "週三": [{ s: "數學", t: "盧佩雯老師" }, { s: "國語", t: "盧佩雯老師" }, { s: "生活", t: "盧佩雯老師" }, { s: "生活", t: "盧佩雯老師" }, null, null, null], "週四": [{ s: "生活(舞蹈)", t: "陳瓊華老師" }, { s: "數學", t: "盧佩雯老師" }, { s: "體育", t: "盧佩雯老師" }, { s: "國語", t: "盧佩雯老師" }, null, null, null], "週五": [{ s: "生活(美術)", t: "姜麗玉老師" }, { s: "數學", t: "盧佩雯老師" }, { s: "生活", t: "盧佩雯老師" }, { s: "國語", t: "盧佩雯老師" }, null, null, null] } },
      { className: "二年甲班", homeroomTeacher: "曾瀅珈老師", schedule: { "週一": [{ s: "國語", t: "曾瀅珈老師" }, { s: "數學", t: "曾瀅珈老師" }, { s: "生活(音樂)", t: "許蓓宜老師" }, { s: "國語", t: "曾瀅珈老師" }, null, null, null], "週二": [{ s: "體育", t: "曾瀅珈老師" }, { s: "本土語", t: "陳香蘭老師", isManualShared: true }, { s: "國語", t: "曾瀅珈老師" }, { s: "數學", t: "曾瀅珈老師" }, { s: "生活", t: "曾瀅珈老師" }, { s: "國語", t: "曾瀅珈老師" }, { s: "彈性(漁鄉)", t: "曾澄珈老師" }], "週三": [{ s: "數學", t: "曾瀅珈老師" }, { s: "國語", t: "曾瀅珈老師" }, { s: "彈性(英語)", t: "葉佩綺老師" }, { s: "彈性(英語)", t: "葉佩綺老師" }, null, null, null], "週四": [{ s: "數學", t: "曾瀅珈老師" }, { s: "生活", t: "曾瀅珈老師" }, { s: "生活(舞蹈)", t: "陳瓊華老師" }, { s: "體育", t: "曾瀅珈老師" }, null, null, null], "週五": [{ s: "數學", t: "曾瀅珈老師" }, { s: "國語", t: "曾瀅珈老師" }, { s: "生活(美術)", t: "姜麗玉老師" }, { s: "健康", t: "洪瑄妙老師" }, null, null, null] } },
      { className: "三年甲班", homeroomTeacher: "鄭永章老師", schedule: { "週一": [{ s: "創鼓團練", t: "鄭永章老師" }, { s: "數學", t: "鄭永章老師" }, { s: "國語", t: "鄭永章老師" }, { s: "自然", t: "陳香蘭老師" }, { s: "國語", t: "鄭永章老師" }, { s: "音樂", t: "許蓓宜老師" }, { s: "社會", t: "鄭永章老師" }], "週二": [{ s: "本土語言", t: "陳香蘭老師" }, { s: "數學", t: "鄭永章老師" }, { s: "國語", t: "鄭永章老師" }, { s: "國語", t: "鄭永章老師" }, { s: "數學", t: "鄭永章老師" }, null, null], "週三": [{ s: "體育", t: "謝淑君老師" }, { s: "健康", t: "洪瑄妙老師" }, { s: "社會", t: "鄭永章老師" }, { s: "綜合", t: "陳香蘭老師" }, null, null, null], "週四": [{ s: "國語", t: "鄭永章老師" }, { s: "數學", t: "鄭永章老師" }, { s: "資訊", t: "黃自正主任" }, { s: "舞蹈", t: "陳瓊華老師" }, { s: "彈性(英)", t: "謝淑君老師" }, { s: "英文", t: "葉佩綺老師" }, { s: "彈性(漁鄉)", t: "鄭永章老師" }], "週五": [{ s: "體育", t: "謝淑君老師" }, { s: "數學", t: "鄭永章老師" }, { s: "國語", t: "鄭永章老師" }, { s: "國語", t: "鄭永章老師" }, { s: "綜合", t: "陳香蘭老師" }, { s: "美術", t: "姜麗玉老師" }, { s: "自然", t: "陳香蘭老師" }] } }
    ];

    const App = () => {
      const [data, setData] = React.useState(INITIAL_DATA);
      const [subjectTargets, setSubjectTargets] = React.useState({
        "一年甲班": { "國語": 6, "數學": 4, "生活": 3, "體育": 2, "彈性(英語)": 2, "本土語": 1, "彈性(漁鄉)": 1 },
        "二年甲班": { "國語": 6, "數學": 4, "生活": 3, "體育": 2, "彈性(英語)": 2, "本土語": 1, "彈性(漁鄉)": 1 },
        "三年甲班": { "國語": 5, "數學": 4, "社會": 3, "自然": 3, "綜合": 2, "英文": 1, "本土語言": 1 }
      });
      const [viewMode, setViewMode] = React.useState('class');
      const [isEditMode, setIsEditMode] = React.useState(false);
      const [selectedClass, setSelectedClass] = React.useState(INITIAL_DATA[0].className);
      const [selectedTeacher, setSelectedTeacher] = React.useState(INITIAL_DATA[0].homeroomTeacher);
      const [isGridExpanded, setIsGridExpanded] = React.useState(false);
      const [editingCell, setEditingCell] = React.useState(null);
      const [showConflictList, setShowConflictList] = React.useState(false);
      const [showClassManager, setShowClassManager] = React.useState(false);
      const [exportPreview, setExportPreview] = React.useState(null);
      const [pendingSlot, setPendingSlot] = React.useState({ s: "", t: "", c: "", isManualShared: false });

      // 訊息提示與視窗狀態
      const [toast, setToast] = React.useState(null);
      const [deletePending, setDeletePending] = React.useState(null);
      const [renamePending, setRenamePending] = React.useState(null);
      const [addPlanPending, setAddPlanPending] = React.useState(false);
      const [newClassNameInput, setNewClassNameInput] = React.useState("");
      const [newPlanNameInput, setNewPlanNameInput] = React.useState("");

      const showToast = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };

      const classList = React.useMemo(() => data.map(c => c.className), [data]);
      const teachersList = React.useMemo(() => {
        const list = new Set();
        data.forEach(c => {
          list.add(c.homeroomTeacher);
          Object.values(c.schedule).forEach(day => day.forEach(s => s && list.add(s.t)));
        });
        return Array.from(list).filter(Boolean).sort();
      }, [data]);

      const getOverlapInfo = React.useCallback((teacher, subject, day, timeIdx, currentClassName) => {
        if (!teacher) return null;
        for (const cls of data) {
          if (cls.className === currentClassName) continue;
          const other = cls.schedule[day]?.[timeIdx];
          if (other && other.t === teacher) {
            return { otherClass: cls.className, otherSubject: other.s || "未命名" };
          }
        }
        return null;
      }, [data]);

      // 統計計算
      const stats = React.useMemo(() => {
        if (viewMode === 'class') {
          const target = selectedClass;
          const cls = data.find(c => c.className === target);
          const currentCount = {};
          if (cls) {
            Object.values(cls.schedule).forEach(d => d.forEach(s => { if (s) currentCount[s.s] = (currentCount[s.s] || 0) + 1; }));
          }
          const targets = subjectTargets[target] || {};
          return Object.entries(targets).map(([s, t]) => ({ subject: s, current: currentCount[s] || 0, target: t, type: 'class' }));
        } else {
          const targetT = selectedTeacher;
          const counts = {};
          let total = 0;
          data.forEach(cls => {
            Object.values(cls.schedule).forEach(day => {
              day.forEach(slot => {
                if (slot && slot.t === targetT) {
                  counts[slot.s] = (counts[slot.s] || 0) + 1;
                  total++;
                }
              });
            });
          });
          return { items: Object.entries(counts).map(([s, c]) => ({ subject: s, current: c, type: 'teacher' })), total };
        }
      }, [data, selectedClass, selectedTeacher, viewMode, subjectTargets]);

      const overlaps = React.useMemo(() => {
        const list = [];
        DAYS.forEach(day => {
          TIMES.forEach((_, tIdx) => {
            const teacherMap = {};
            data.forEach(cls => {
              const slot = cls.schedule[day]?.[tIdx];
              if (slot && slot.t) {
                if (teacherMap[slot.t]) {
                  const prev = teacherMap[slot.t];
                  list.push({
                    teacher: slot.t, day, timeLabel: TIMES[tIdx].period,
                    classes: [prev.className, cls.className],
                    subjects: [prev.s, slot.s]
                  });
                }
                teacherMap[slot.t] = { className: cls.className, s: slot.s };
              }
            });
          });
        });
        return list;
      }, [data]);

      // 功能操作
      const handleFullExport = () => {
        const blob = new Blob([JSON.stringify({ data, subjectTargets }, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `國小排課備份.json`;
        link.click();
        showToast("備份匯出成功");
      };

      const handleFullImport = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const imported = JSON.parse(event.target.result);
            if (imported.data) setData(imported.data);
            if (imported.subjectTargets) setSubjectTargets(imported.subjectTargets);
            showToast("還原備份成功");
          } catch (err) { showToast("還原失敗，請檢查檔案內容"); }
        };
        reader.readAsText(file);
      };

      const executeRename = () => {
        if (!renamePending || !newClassNameInput) return;
        const { oldName } = renamePending;
        setData(prev => prev.map(c => c.className === oldName ? { ...c, className: newClassNameInput } : c));
        setSubjectTargets(prev => {
          const next = { ...prev }; next[newClassNameInput] = next[oldName]; delete next[oldName]; return next;
        });
        if (selectedClass === oldName) setSelectedClass(newClassNameInput);
        showToast("更名成功");
        setRenamePending(null);
      };

      const executeAddPlan = () => {
        if (!newPlanNameInput.trim()) return;
        setSubjectTargets(p => ({ ...p, [selectedClass]: { ...p[selectedClass], [newPlanNameInput.trim()]: 1 } }));
        setAddPlanPending(false);
        setNewPlanNameInput("");
      };

      const handleAddClass = (name) => {
        if (!name || classList.includes(name)) return;
        setData([...data, { className: name, homeroomTeacher: "專任教師", schedule: DAYS.reduce((acc, d) => ({ ...acc, [d]: Array(7).fill(null) }), {}) }]);
        setSubjectTargets({ ...subjectTargets, [name]: {} });
        showToast(`已新增：${name}`);
      };

      const executeDelete = () => {
        if (!deletePending) return;
        if (data.length <= 1) { showToast("無法刪除唯一的班級"); setDeletePending(null); return; }
        const newData = data.filter(c => c.className !== deletePending);
        setData(newData);
        if (selectedClass === deletePending) setSelectedClass(newData[0].className);
        setDeletePending(null);
      };

      const handleSave = () => {
        const { s, t, c, isManualShared } = pendingSlot;
        const finalSlot = (s && s.trim() !== "") ? { s: s.trim(), t, isManualShared } : null;
        setData(prev => prev.map(cls => {
          if (cls.className === c) {
            const daySlots = [...(cls.schedule[editingCell.day] || Array(7).fill(null))];
            daySlots[editingCell.timeIdx] = finalSlot;
            return { ...cls, schedule: { ...cls.schedule, [editingCell.day]: daySlots } };
          }
          return cls;
        }));
        setEditingCell(null);
        showToast("已更新課表");
      };

      const handleCellClick = (day, tIdx) => {
        if (viewMode === 'class') {
          setEditingCell({ day, timeIdx: tIdx });
        } else {
          const foundClass = data.find(c => c.schedule[day]?.[tIdx]?.t === selectedTeacher);
          if (foundClass) {
            setSelectedClass(foundClass.className);
            setEditingCell({ day, timeIdx: tIdx });
          } else {
            showToast("提示：教師視圖空白處無法新增。");
          }
        }
      };

      const finalizeExport = (type) => {
        if (type === 'pdf') { window.print(); }
        else {
          const container = document.getElementById('timetable-export-area');
          const header = `<html><head><meta charset='utf-8'><style>table { border-collapse: collapse; width: 100%; table-layout: fixed; } th, td { border: 1pt solid black; padding: 12px; text-align: center; vertical-align: middle; font-family: 'Noto Sans TC'; }</style></head><body>`;
          const blob = new Blob(['\ufeff', header + container.innerHTML + '</body></html>'], { type: 'application/msword' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url; link.download = `${viewMode === 'class' ? selectedClass : selectedTeacher}_課表.doc`; link.click();
        }
        setExportPreview(null);
      };

      const updateSubjectPlan = (oldName, newName, newTarget) => {
        setSubjectTargets(prev => {
          const classTargets = { ...prev[selectedClass] };
          if (oldName !== newName) delete classTargets[oldName];
          classTargets[newName] = parseInt(newTarget) || 0;
          return { ...prev, [selectedClass]: classTargets };
        });
      };

      const removeSubjectPlan = (name) => {
        setSubjectTargets(prev => {
          const next = { ...prev[selectedClass] }; delete next[name];
          return { ...prev, [selectedClass]: next };
        });
      };

      React.useEffect(() => {
        if (editingCell) {
          const cls = data.find(c => c.className === selectedClass);
          const slot = cls?.schedule[editingCell.day]?.[editingCell.timeIdx];
          setPendingSlot({ s: slot?.s || "", t: slot?.t || cls?.homeroomTeacher || "", c: selectedClass, isManualShared: !!slot?.isManualShared });
        }
      }, [editingCell, selectedClass]);

      return (
        <div className="min-h-screen bg-[#F1F5F9] pb-10 font-black">
          {toast && <div className="fixed top-6 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-full shadow-2xl bg-slate-800 text-white animate-bounce">{toast}</div>}

          {/* 彈窗 UI */}
          {deletePending && (
            <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[95] flex items-center justify-center p-4">
              <div className="bg-white rounded-[32px] p-8 shadow-2xl w-full max-w-sm text-center border-4 border-rose-50 font-black">
                <h3 className="text-xl mb-2">確定刪除 {deletePending}？</h3>
                <div className="grid grid-cols-2 gap-4">
                  <button onClick={() => setDeletePending(null)} className="py-3 bg-slate-100 rounded-2xl font-black">取消</button>
                  <button onClick={executeDelete} className="py-3 bg-rose-600 text-white rounded-2xl font-black shadow-lg">確認刪除</button>
                </div>
              </div>
            </div>
          )}

          {renamePending && (
            <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[95] flex items-center justify-center p-4">
              <div className="bg-white rounded-[32px] p-8 shadow-2xl w-full max-w-sm text-center border-4 border-indigo-50 font-black font-black">
                <h3 className="text-xl mb-4 font-black font-black">修改教室名稱</h3>
                <input autoFocus className="w-full bg-slate-50 border-2 rounded-2xl p-4 text-center text-lg font-black mb-8" value={newClassNameInput} onChange={(e) => setNewClassNameInput(e.target.value)} />
                <div className="grid grid-cols-2 gap-4">
                  <button onClick={() => setRenamePending(null)} className="py-3 bg-slate-100 rounded-2xl font-black font-black">取消</button>
                  <button onClick={executeRename} className="py-3 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">確認修改</button>
                </div>
              </div>
            </div>
          )}

          {addPlanPending && (
            <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[95] flex items-center justify-center p-4">
              <div className="bg-white rounded-[32px] p-8 shadow-2xl w-full max-w-sm text-center border-4 border-indigo-50 font-black font-black">
                <h3 className="text-xl mb-4">新增計畫科目</h3>
                <input autoFocus className="w-full bg-slate-50 border-2 rounded-2xl p-4 text-center text-lg font-black outline-none mb-8 font-black" value={newPlanNameInput} onChange={(e) => setNewPlanNameInput(e.target.value)} />
                <div className="grid grid-cols-2 gap-4 font-black">
                  <button onClick={() => setAddPlanPending(false)} className="py-3 bg-slate-100 rounded-2xl font-black font-black">取消</button>
                  <button onClick={executeAddPlan} className="py-3 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">確認新增</button>
                </div>
              </div>
            </div>
          )}

          <header className="bg-white border-b sticky top-0 z-40 px-6 py-4 flex flex-col lg:flex-row items-center justify-between gap-4 shadow-sm print:hidden font-black">
            <div className="flex items-center gap-4 text-left font-black">
              <div className="bg-indigo-600 p-2 rounded-xl text-white shadow-lg"><IconSchool /></div>
              <h1 className="text-xl font-black text-slate-800">國小排課系統</h1>
            </div>
            <div className="flex items-center gap-3">
              {overlaps.length > 0 && <button onClick={() => setShowConflictList(true)} className="bg-rose-600 text-white px-4 py-2 rounded-xl text-xs font-black animate-pulse shadow-md hover:bg-rose-700 flex items-center gap-2 font-black font-black"><IconBell /> {overlaps.length} 衝突偵測</button>}
              <div className="flex items-center gap-2 bg-slate-100 p-1 rounded-2xl border font-black">
                <button onClick={() => setViewMode('class')} className={`px-4 py-2 rounded-xl text-sm transition-all font-black ${viewMode === 'class' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>班級視圖</button>
                <button onClick={() => setViewMode('teacher')} className={`px-4 py-2 rounded-xl text-sm transition-all font-black ${viewMode === 'teacher' ? 'bg-white shadow text-indigo-600' : 'text-slate-500'}`}>教師視圖</button>
                <button onClick={() => setIsEditMode(!isEditMode)} className={`px-4 py-2 rounded-xl text-sm flex items-center gap-2 transition-all font-black font-black ${isEditMode ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-400'}`}><IconEdit /> {isEditMode ? '結束排課' : '排課模式'}</button>
              </div>
              <button onClick={() => setShowClassManager(true)} className="p-3 bg-white border rounded-xl hover:bg-slate-50 shadow-sm font-black font-black font-black"><IconSettings /></button>
            </div>
          </header>

          <main className="max-w-[1600px] mx-auto p-4 lg:p-8 space-y-6">
            <div className="bg-white p-5 rounded-[28px] border flex items-center justify-between gap-6 shadow-sm overflow-x-auto custom-scroll print:hidden">
              <div className="flex items-center gap-6">
                <div className="flex items-center gap-3 shrink-0">
                  <span className="text-xs font-black text-slate-400 uppercase tracking-widest font-black">目前選擇：</span>
                  <select value={viewMode === 'class' ? selectedClass : selectedTeacher} onChange={e => viewMode === 'class' ? setSelectedClass(e.target.value) : setSelectedTeacher(e.target.value)} className="bg-slate-50 border rounded-xl px-4 py-2 text-base font-black text-slate-700 min-w-[160px] cursor-pointer">
                    {viewMode === 'class' ? classList.map(c => <option key={c} value={c}>{c}</option>) : teachersList.map(t => <option key={t} value={t}>{t}</option>)}
                  </select>
                </div>
                <button onClick={() => setIsGridExpanded(!isGridExpanded)} className={`px-5 py-2 border rounded-xl text-sm font-black flex items-center gap-2 transition-all ${isGridExpanded ? 'bg-indigo-50 border-indigo-200 text-indigo-600 shadow-sm font-black' : 'bg-white text-slate-500 font-black'}`}><IconChart /> 教學計畫統計</button>
              </div>
              <div className="flex items-center gap-3 shrink-0 font-black">
                <button onClick={() => setExportPreview('pdf')} className="bg-slate-800 text-white px-6 py-2 rounded-xl text-sm font-black flex items-center gap-2 shadow hover:bg-black font-black"><IconPrint /> PDF 匯出</button>
                <button onClick={() => setExportPreview('word')} className="border-2 border-indigo-600 text-indigo-600 px-6 py-2 rounded-xl text-sm font-black flex items-center gap-2 hover:bg-indigo-50 font-black font-black font-black font-black"><IconFile /> Word 匯出</button>
              </div>
            </div>

            {isGridExpanded && (
              <div className="bg-white rounded-[32px] border p-8 shadow-sm text-left animate-in slide-in-from-top-4 duration-300 print:hidden font-black">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-xl font-black text-slate-800 flex items-center gap-3">{viewMode === 'class' ? `${selectedClass} 節數計畫` : `${selectedTeacher} 授課統計`}</h2>
                  {isEditMode && viewMode === 'class' && <button onClick={() => setAddPlanPending(true)} className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-black shadow-lg">+ 新增計畫科目</button>}
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                  {viewMode === 'teacher' && (
                    <div className="p-4 rounded-[24px] border-4 border-indigo-200 bg-indigo-50 flex flex-col items-center justify-center text-center shadow-md">
                      <div className="text-xs font-black text-indigo-500 mb-1">總授課節數</div>
                      <div className="text-4xl font-black text-indigo-700 tracking-tighter">{stats.total} <span className="text-xs font-black font-black">節</span></div>
                      <div className="mt-2 text-[10px] bg-indigo-600 text-white px-2 py-0.5 rounded-full">全校累計</div>
                    </div>
                  )}
                  {(viewMode === 'class' ? stats : stats.items).map((s, idx) => {
                    const isComplete = s.current === s.target;
                    return (
                      <div key={idx} className={`p-4 rounded-[24px] border-2 transition-all flex flex-col relative group ${isEditMode && viewMode === 'class' ? 'border-indigo-300 bg-indigo-50/20 font-black' : (isComplete ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-slate-100 font-black')}`}>
                        {isEditMode && viewMode === 'class' && <button onClick={() => removeSubjectPlan(s.subject)} className="absolute -top-2 -right-2 bg-rose-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 z-10 transition-all"><IconX size={10} /></button>}
                        {isEditMode && viewMode === 'class' ? (
                          <div className="space-y-2">
                            <input className="w-full bg-white border rounded-lg p-1 text-xs font-black text-indigo-700 outline-none focus:ring-2 focus:ring-indigo-300 font-black" value={s.subject} onChange={(e) => updateSubjectPlan(s.subject, e.target.value, s.target)} />
                            <div className="flex items-center justify-between text-[10px] text-slate-400 font-black font-black font-black">應排: <input type="number" className="w-12 bg-white border rounded-lg p-1 text-center font-black outline-none font-black" value={s.target} onChange={(e) => updateSubjectPlan(s.subject, s.subject, e.target.value)} /></div>
                            <div className="text-[10px] text-indigo-500 text-center">已排：{s.current} 節</div>
                          </div>
                        ) : (
                          <div className="text-center">
                            <div className="text-xs font-black text-slate-500 mb-1 truncate font-black font-black">{s.subject}</div>
                            <div className={`text-2xl font-black ${viewMode === 'class' && isComplete ? 'text-emerald-600' : 'text-indigo-600'}`}>{s.current} {s.target ? <span className="text-xs opacity-50 font-bold font-black">/ {s.target}</span> : <span className="text-xs opacity-50">節</span>}</div>
                            <div className={`mt-2 text-[9px] px-2 py-0.5 rounded-full inline-block font-black ${viewMode === 'class' && isComplete ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-400'}`}>{viewMode === 'class' ? (isComplete ? '達成' : '排課中') : '授課科目'}</div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            <div className="w-full overflow-x-auto custom-scroll pb-4 font-black">
              <div id="timetable-container" className="bg-white rounded-[40px] border shadow-sm overflow-hidden min-w-[1000px] print:min-w-0">
                <table className="fixed-table border-collapse font-black font-black">
                  <thead><tr className="bg-slate-50 text-slate-400 border-b font-black font-black font-black font-black font-black"><th>時間</th>{DAYS.map(d => <th key={d}>{d}</th>)}</tr></thead>
                  <tbody className="divide-y">
                    {TIMES.map((time, tIdx) => (
                      <tr key={time.id}>
                        <td className="py-8 px-2 text-center border-r bg-slate-50/10 font-black"><span className="text-xl text-slate-800 block leading-none font-black font-black font-black font-black">{time.period}</span><span className="text-[10px] text-slate-400 mt-2 block font-normal font-black">{time.time}</span></td>
                        {DAYS.map(day => {
                          const cls = data.find(c => c.className === selectedClass);
                          let slot = null;
                          if (viewMode === 'class') slot = cls?.schedule[day]?.[tIdx];
                          else data.forEach(c => { const s = c.schedule[day]?.[tIdx]; if (s && s.t === selectedTeacher) slot = { ...s, displayLabel: c.className }; });
                          const overlap = slot && viewMode === 'class' ? getOverlapInfo(slot.t, slot.s, day, tIdx, selectedClass) : null;
                          const isConflict = overlap && !slot?.isManualShared;
                          const cellBg = slot ? (slot.isManualShared ? 'bg-purple-600 text-white shadow-lg' : (isConflict ? 'bg-rose-50 border-2 border-rose-500 overlap-warning shadow-xl' : 'bg-white border border-slate-100 shadow-sm')) : (isEditMode ? 'bg-white border-2 border-dashed border-slate-200' : 'bg-slate-50/50');
                          return (
                            <td key={day} className="p-2 border-r align-top relative font-black">
                              <div onClick={() => handleCellClick(day, tIdx)} className={`lesson-cell min-h-[110px] p-4 flex flex-col items-center justify-center relative font-black font-black font-black font-black ${cellBg}`}>
                                {slot ? (
                                  <div className="text-center w-full">
                                    <div className="text-xl font-black tracking-tight">{slot.s}</div>
                                    <div className="text-[10px] opacity-70 font-black mt-1 uppercase font-black">{viewMode === 'class' ? String(slot.t).replace('老師', '') : slot.displayLabel}</div>
                                    {isConflict && <span className="mt-2 bg-rose-600 text-white text-[9px] px-2 py-0.5 rounded-full animate-bounce inline-block">衝突 !</span>}
                                    {slot.isManualShared && <span className="mt-2 bg-white/20 text-[9px] px-2 py-0.5 rounded-full border border-white/30 font-black inline-block font-black font-black font-black">✓ 合上</span>}
                                  </div>
                                ) : (isEditMode && <IconPlus className="text-slate-300" />)}
                              </div>
                            </td>
                          );
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </main>

          {showClassManager && (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-[80] flex items-center justify-center p-4 font-black">
              <div className="bg-white rounded-[44px] shadow-2xl w-full max-w-2xl flex flex-col max-h-[85vh] overflow-hidden">
                <div className="p-8 border-b flex justify-between items-center bg-slate-50/50 font-black font-black font-black">
                  <div className="text-left font-black"><h2 className="text-2xl text-slate-800 flex items-center gap-2 font-black tracking-tight font-black font-black">全校教室管理</h2><p className="text-[10px] text-slate-400 mt-1 uppercase tracking-widest font-black">Management Center</p></div>
                  <button onClick={() => setShowClassManager(false)} className="p-4 bg-white border rounded-3xl hover:bg-rose-50 shadow-sm transition-all font-black"><IconX /></button>
                </div>
                <div className="p-8 overflow-y-auto custom-scroll space-y-10 text-left font-black">
                  <section>
                    <label className="block text-[10px] text-slate-400 mb-4 uppercase tracking-widest font-black">資料備份與還原</label>
                    <div className="grid grid-cols-2 gap-4">
                      <button onClick={handleFullExport} className="bg-indigo-600 text-white p-4 rounded-3xl font-black shadow-lg flex items-center justify-center gap-2 active:scale-95 font-black font-black"><IconDownload /> 匯出 JSON 備份</button>
                      <div className="relative font-black">
                        <input type="file" accept=".json" onChange={handleFullImport} className="absolute inset-0 opacity-0 cursor-pointer z-10 font-black" />
                        <button className="w-full bg-white border-2 border-indigo-200 text-indigo-600 p-4 rounded-3xl font-black flex items-center justify-center gap-2 font-black font-black">匯入 JSON 備份</button>
                      </div>
                    </div>
                  </section>
                  <section>
                    <label className="block text-[10px] text-slate-400 mb-4 uppercase tracking-widest font-black">現有教室清單</label>
                    <div className="space-y-4">
                      <div className="flex gap-2 mb-6 font-black font-black">
                        <input id="new-class-in" className="flex-1 bg-slate-50 border rounded-2xl p-4 font-black outline-none shadow-inner font-black" placeholder="輸入教室名稱..." />
                        <button onClick={() => { const i = document.getElementById('new-class-in'); handleAddClass(i.value); i.value = ""; }} className="bg-indigo-600 text-white px-8 rounded-2xl font-black shadow-lg active:scale-95 transition-all font-black font-black">新增</button>
                      </div>
                      <div className="grid grid-cols-1 gap-3 font-black font-black">
                        {classList.map(name => (
                          <div key={name} className="flex justify-between items-center p-5 bg-slate-50 rounded-[28px] border font-black shadow-sm group font-black">
                            <span className="text-lg text-slate-700 font-black">{name}</span>
                            <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-all font-black">
                              <button onClick={() => { setRenamePending({ oldName: name }); setNewClassNameInput(name); }} className="text-amber-500 bg-white border p-3 rounded-2xl shadow-sm hover:bg-amber-50 transition-all font-black font-black font-black"><IconEdit /></button>
                              <button onClick={() => setDeletePending(name)} className="text-rose-400 bg-white border p-3 rounded-2xl shadow-sm hover:bg-rose-50 transition-all font-black font-black font-black font-black"><IconTrash /></button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </section>
                </div>
              </div>
            </div>
          )}

          {/* 編輯彈窗 */}
          {editingCell && (
            <div className="fixed inset-0 bg-black/50 backdrop-blur-xl z-[60] flex items-center justify-center p-4 overflow-y-auto font-black" onClick={() => setEditingCell(null)}>
              <div className="bg-white rounded-[48px] shadow-2xl w-full max-w-4xl relative flex flex-col overflow-hidden font-black font-black font-black" onClick={e => e.stopPropagation()} style={{ maxHeight: '90vh' }}>
                <div className="p-8 border-b flex justify-between items-center bg-white/95 sticky top-0 z-10 font-black font-black">
                  <div className="text-left font-black font-black font-black font-black font-black"><span className="text-[10px] text-indigo-500 uppercase tracking-widest block font-black font-black">Schedule Editor</span><h2 className="text-2xl text-slate-800 font-black font-black font-black font-black">{selectedClass} · {editingCell.day} {TIMES[editingCell.timeIdx].period}</h2></div>
                  <button onClick={() => setEditingCell(null)} className="p-4 bg-slate-50 hover:bg-rose-500 hover:text-white rounded-3xl border shadow-sm transition-all font-black"><IconX /></button>
                </div>
                <div className="p-10 overflow-y-auto custom-scroll font-black text-left font-black font-black">
                  <div className="grid grid-cols-1 md:grid-cols-12 gap-10 font-black">
                    <div className="md:col-span-7 space-y-10 font-black">
                      <div>
                        <label className="block text-[10px] text-slate-400 mb-4 uppercase tracking-widest font-black font-black">快速填入計畫科目</label>
                        <div className="grid grid-cols-3 gap-3 font-black font-black">
                          {(subjectTargets[selectedClass] ? Object.entries(subjectTargets[selectedClass]) : []).map(([s, t], i) => {
                            const cls = data.find(c => c.className === selectedClass);
                            let count = 0;
                            Object.values(cls?.schedule || {}).forEach(day => day.forEach(slot => { if (slot && slot.s === s) count++; }));
                            return (
                              <button key={i} onClick={() => setPendingSlot({ ...pendingSlot, s: s })} className={`p-4 rounded-[28px] border-2 text-center transition-all ${pendingSlot.s === s ? 'border-indigo-600 bg-indigo-50 text-indigo-700 ring-4 ring-indigo-50 shadow-md font-black font-black' : 'bg-white border-slate-100 hover:border-indigo-200 font-black'}`}>
                                <div className="text-xs font-black truncate">{s}</div><div className="text-[10px] opacity-60 font-black font-black font-black">{count}/{t}</div>
                              </button>
                            );
                          })}
                        </div>
                      </div>
                      <div className="pt-8 border-t space-y-8 text-slate-700 font-black">
                        <div className="grid grid-cols-2 gap-8 text-center font-black">
                          <div className="space-y-2 font-black font-black font-black"><label className="text-[11px] text-slate-400 font-black font-black">科目名稱</label><input value={pendingSlot.s} onChange={e => setPendingSlot({ ...pendingSlot, s: e.target.value })} className="w-full bg-slate-50 border rounded-2xl p-5 text-xl font-black outline-none focus:ring-4 focus:ring-indigo-100 text-center" /></div>
                          <div className="space-y-2 font-black font-black font-black font-black"><label className="text-[11px] text-slate-400 font-black font-black">任課老師</label><select value={pendingSlot.t} onChange={e => setPendingSlot({ ...pendingSlot, t: e.target.value })} className="w-full bg-slate-50 border rounded-2xl p-5 text-lg font-black outline-none focus:ring-4 focus:ring-indigo-100 text-center cursor-pointer font-black font-black font-black font-black">{teachersList.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                        </div>
                        <div className="bg-amber-50 border border-amber-200 p-4 rounded-2xl flex items-center justify-center gap-3 font-black">
                          <p className="text-amber-700 text-sm font-black font-black">修改完成後，請務必點擊下方「儲存變更」按鈕</p>
                        </div>
                        <div className="space-y-3 font-black">
                          <button onClick={() => setPendingSlot({ ...pendingSlot, s: "", t: "" })} className="w-full bg-white border-2 border-rose-500 text-rose-600 py-4 rounded-[36px] font-black text-lg hover:bg-rose-50 flex items-center justify-center gap-2 font-black font-black font-black font-black"><IconEraser /> 清空這節課</button>
                          <button onClick={handleSave} className="w-full bg-indigo-600 text-white py-5 px-8 rounded-[36px] font-black text-xl hover:bg-indigo-700 shadow-xl flex items-center justify-center gap-3 font-black font-black font-black font-black"><IconSave /> 儲存變更</button>
                        </div>
                      </div>
                    </div>
                    <div className="md:col-span-5 bg-slate-50 rounded-[44px] p-8 border border-slate-200 shadow-inner flex flex-col font-black">
                      <h3 className="text-xs font-black text-slate-500 mb-6 uppercase flex items-center gap-2 justify-center tracking-widest font-black">重疊偵測與合上</h3>
                      <div className="flex-1 space-y-6 font-black">
                        <div className="min-h-[140px] flex items-center justify-center text-center font-black">
                          {getOverlapInfo(pendingSlot.t, pendingSlot.s, editingCell.day, editingCell.timeIdx, selectedClass) ? (
                            <div className={`w-full p-6 rounded-[32px] border-2 shadow-sm flex flex-col items-center gap-2 font-black font-black font-black font-black font-black ${pendingSlot.isManualShared ? 'bg-indigo-100 border-indigo-200 text-indigo-800' : 'bg-rose-100 border-rose-200 text-rose-800'}`}>
                              <div className="text-xs font-black uppercase opacity-60 font-black font-black font-black">衝突警告</div>
                              <p className="text-sm font-black italic font-black font-black font-black">「{pendingSlot.t}」在 {getOverlapInfo(pendingSlot.t, pendingSlot.s, editingCell.day, editingCell.timeIdx, selectedClass).otherClass} 已排課</p>
                            </div>
                          ) : (
                            <div className="text-center opacity-30 font-black"><IconCheck size={24} className="mx-auto mb-2 font-black font-black font-black font-black" /><p className="text-[10px] uppercase font-black font-black">目前無任課衝突</p></div>
                          )}
                        </div>
                        <div className="h-px bg-slate-200 w-full font-black"></div>
                        <button onClick={() => setPendingSlot({ ...pendingSlot, isManualShared: !pendingSlot.isManualShared })} className={`w-full p-6 rounded-[32px] border-2 transition-all font-black font-black ${pendingSlot.isManualShared ? 'bg-indigo-600 border-indigo-700 text-white shadow-lg shadow-indigo-100 translate-y-[-2px] font-black font-black font-black' : 'bg-white border-slate-300 text-slate-500 hover:border-indigo-400 font-black'}`}>
                          <div className="flex flex-col items-center gap-2 font-black font-black font-black">
                            <div className={`p-2 rounded-full font-black font-black ${pendingSlot.isManualShared ? 'bg-white text-indigo-600' : 'bg-slate-100 text-slate-400'}`}>{pendingSlot.isManualShared ? <IconCheck /> : <IconSync />}</div>
                            <span className="text-lg font-black font-black font-black">{pendingSlot.isManualShared ? "✓ 已標記為合上" : "標記為跨班「合上」"}</span>
                          </div>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* 衝突清單詳細資料 */}
          {showConflictList && (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-[90] flex items-center justify-center p-4">
              <div className="bg-white rounded-[44px] shadow-2xl w-full max-w-4xl flex flex-col max-h-[85vh] overflow-hidden font-black">
                <div className="p-8 border-b flex justify-between items-center bg-rose-50/50 sticky top-0 z-10 font-black font-black">
                  <div className="text-left font-black font-black font-black font-black"><h2 className="text-2xl text-rose-700 flex items-center gap-2 font-black font-black font-black"><IconBell /> 任課重疊詳細清單</h2></div>
                  <button onClick={() => setShowConflictList(false)} className="p-4 bg-white border rounded-3xl hover:bg-rose-100 shadow-sm transition-all font-black"><IconX /></button>
                </div>
                <div className="p-10 overflow-y-auto custom-scroll space-y-4 text-left font-black">
                  {overlaps.map((conflict, idx) => (
                    <div key={idx} className={`p-6 rounded-[32px] border-2 flex items-center justify-between gap-6 font-black font-black ${conflict.isManualShared ? 'bg-indigo-50 border-indigo-100 opacity-60 font-black' : 'bg-rose-50 border-rose-100 shadow-sm font-black'}`}>
                      <div className="flex items-center gap-6 font-black font-black">
                        <div className={`p-4 rounded-2xl font-black text-center min-w-[100px] ${conflict.isManualShared ? 'bg-indigo-600 text-white' : 'bg-rose-600 text-white'}`}><div className="text-xs opacity-70 mb-1 font-black font-black">{conflict.day}</div><div className="text-lg leading-none font-black">{conflict.timeLabel}</div></div>
                        <div><div className="text-xl mb-1 font-black font-black">{conflict.teacher}</div><div className="text-sm opacity-80 font-black">{conflict.classes[0]} ({conflict.subjects[0]}) 與 {conflict.classes[1]} ({conflict.subjects[1]})</div></div>
                      </div>
                      <div className="flex items-center gap-3">
                        {conflict.isManualShared ? <span className="bg-indigo-600 text-white px-4 py-2 rounded-2xl text-xs font-black">✓ 已標記合上</span> : <span className="bg-rose-600 text-white px-4 py-2 rounded-2xl text-xs font-black animate-pulse font-black font-black font-black">衝突中</span>}
                        <button onClick={() => { setViewMode('class'); setSelectedClass(conflict.classes[0]); setShowConflictList(false); }} className="p-3 bg-white border rounded-2xl hover:bg-slate-50 transition-all shadow-sm font-black font-black font-black font-black font-black font-black"><IconEye /></button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* 匯出預覽視窗 */}
          {exportPreview && (
            <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[70] flex items-center justify-center p-4">
              <div className="bg-white rounded-[48px] shadow-2xl w-full max-w-6xl flex flex-col max-h-[90vh] overflow-hidden font-black">
                <div className="p-8 border-b flex justify-between items-center bg-slate-50/50">
                  <h2 className="text-2xl text-slate-800 font-black tracking-tight">課表匯出預覽 ({viewMode === 'class' ? '班級' : '教師'})</h2>
                  <button onClick={() => setExportPreview(null)} className="p-4 bg-white border rounded-2xl hover:bg-rose-50 transition-all font-black"><IconX /></button>
                </div>
                <div className="flex-1 overflow-y-auto p-10 bg-slate-100/30 custom-scroll text-center">
                  <div id="timetable-export-area" className="bg-white p-12 shadow-inner border rounded-[40px] min-w-[850px] mx-auto scale-90 origin-top inline-block border-2 border-slate-900 font-black">
                    <h1 className="text-3xl font-black text-center mb-10 font-black">{viewMode === 'class' ? selectedClass : selectedTeacher} 課表</h1>
                    <table className="w-full border-2 border-black table-fixed text-center font-black">
                      <thead><tr className="bg-slate-100 font-black"><th className="border-2 border-black p-4 w-28 text-xl font-black">節次</th>{DAYS.map(d => <th key={d} className="border-2 border-black p-4 text-xl">{d}</th>)}</tr></thead>
                      <tbody>
                        {TIMES.map((t, idx) => (
                          <tr key={idx}>
                            <td className="border-2 border-black p-4 bg-slate-50 font-black font-black"><div className="text-lg leading-tight">{t.period}</div><div className="text-[10px] opacity-60 mt-1 font-black font-black">{t.time}</div></td>
                            {DAYS.map(d => {
                              let cell = null;
                              if (viewMode === 'class') {
                                cell = data.find(c => c.className === selectedClass)?.schedule[d]?.[idx];
                              } else {
                                data.forEach(c => {
                                  const s = c.schedule[d]?.[idx];
                                  if (s && s.t === selectedTeacher) cell = { ...s, displayLabel: c.className };
                                });
                              }
                              return (
                                <td key={d} className="border-2 border-black p-4 h-32 align-middle font-black font-black font-black">
                                  {cell && (
                                    <div className="font-black">
                                      <div style={{ fontSize: '18pt', fontWeight: 'bold' }}>{cell.s}</div>
                                      <div style={{ fontSize: '10pt', fontWeight: 'bold', color: '#555', marginTop: '4pt' }}>
                                        {viewMode === 'class' ? cell.t : cell.displayLabel}
                                      </div>
                                    </div>
                                  )}
                                </td>
                              );
                            })}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
                <div className="p-8 border-t bg-white flex justify-center gap-6 font-black">
                  <button onClick={() => setExportPreview(null)} className="px-10 py-4 rounded-3xl bg-slate-100 text-slate-500 hover:bg-slate-200 transition-all font-black">取消</button>
                  <button onClick={() => finalizeExport(exportPreview)} className={`px-12 py-4 rounded-3xl text-white shadow-xl flex items-center gap-3 active:scale-95 transition-all ${exportPreview === 'pdf' ? 'bg-slate-900 shadow-slate-300 font-black' : 'bg-indigo-600 shadow-indigo-100 font-black'} font-black font-black font-black font-black`}><IconEye /> 確認匯出</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>