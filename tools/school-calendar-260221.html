<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>學校行事曆生成系統 - 專業增強版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.18.6/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background-color: #f1f5f9;
      color: #334155;
    }

    @media print {
      body {
        background-color: white !important;
        -webkit-print-color-adjust: exact;
      }

      .print\:hidden {
        display: none !important;
      }

      #print-area {
        display: block !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      @page {
        size: A4;
        margin: 10mm;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
      }

      th,
      td {
        border: 1px solid black !important;
        overflow: hidden;
        word-break: break-all;
      }

      .page-break {
        page-break-after: always;
        height: auto;
      }
    }

    .custom-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scroll::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }

    .modal-overlay {
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
  </style>
</head>

<body>
  <div id="root">系統載入中...</div>

  <script type="text/babel" data-presets="react">
    const { useState, useEffect, useMemo, useRef, Fragment } = React;

    // --- 1. 工具函式 ---
    const parseDate = (dateStr) => {
      if (!dateStr) return new Date();
      const [y, m, d] = dateStr.split('-').map(Number);
      return new Date(y, m - 1, d);
    };

    const toLocalDateStr = (date) => {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    };

    const formatDateToShort = (dateStr, isMonthOnly) => {
      if (isMonthOnly) return "待定";
      if (!dateStr) return "";
      const d = parseDate(dateStr);
      return `${d.getMonth() + 1}/${d.getDate()}`;
    };

    const isDateInRange = (dStr, start, end) => dStr >= start && dStr <= end;

    const isWeekendDay = (dateStr) => {
      const d = parseDate(dateStr);
      const day = d.getDay();
      return day === 0 || day === 6;
    };

    const Icon = ({ name, size = 18, className = "" }) => {
      const iconRef = useRef(null);
      useEffect(() => {
        if (window.lucide && iconRef.current) window.lucide.createIcons();
      }, [name]);
      return <span className={`inline-flex items-center justify-center ${className}`} ref={iconRef}><i data-lucide={name} style={{ width: size, height: size }}></i></span>;
    };

    // --- 2. 教育局指定版表格 (BureauTable) ---
    const BureauTable = ({ headerInfo, events, weekMap }) => {
      const start = parseDate(headerInfo.semesterStartDate);
      const end = parseDate(headerInfo.semesterEndDate);
      const rows = [];
      let currentSun = new Date(start);
      currentSun.setDate(start.getDate() - start.getDay());

      while (currentSun <= end) {
        const weekDates = [];
        for (let i = 0; i < 7; i++) {
          const d = new Date(currentSun);
          d.setDate(currentSun.getDate() + i);
          weekDates.push(toLocalDateStr(d));
        }
        const sunStr = toLocalDateStr(currentSun);
        rows.push({ weekNum: weekMap[sunStr] || "", dates: weekDates, month: currentSun.getMonth() + 1 });
        currentSun.setDate(currentSun.getDate() + 7);
      }

      const assessmentKeywords = ['成績考查', '定期評量', '畢業考', '作業抽查', '考', '評量', '抽查'];
      const isAssessment = (title) => assessmentKeywords.some(k => title.includes(k));

      return (
        <table className="w-full border-collapse border-2 border-black text-[11px] leading-tight">
          <thead>
            <tr className="bg-gray-200 text-center font-bold h-10">
              <th className="border border-black w-[40px]">月份</th>
              <th className="border border-black w-[40px]">週次</th>
              {['日', '一', '二', '三', '四', '五', '六'].map(d => (
                <th key={d} className={`border border-black w-[28px] ${d === '日' || d === '六' ? 'text-red-500' : ''}`}>{d}</th>
              ))}
              <th className="border border-black w-[130px]">成績考查&作業抽查</th>
              <th className="border border-black">教務、學務、總務、輔導預定活動</th>
              <th className="border border-black w-[110px]">備註</th>
            </tr>
          </thead>
          <tbody>
            {rows.map((row, idx) => {
              const isFirstInMonth = idx === 0 || rows[idx - 1].month !== row.month;
              const monthSpan = rows.filter(r => r.month === row.month).length;

              const weekEvents = events.filter(e => {
                const inWeek = row.dates.some(dStr => isDateInRange(dStr, e.startDate, e.endDate));
                const isThisMonthTBD = e.isMonthOnly && isFirstInMonth && (parseDate(e.startDate).getMonth() + 1 === row.month);
                return inWeek || isThisMonthTBD;
              });

              return (
                <tr key={idx} className="min-h-[50px]">
                  {isFirstInMonth && (
                    <td className="border border-black text-center font-bold bg-white text-lg" rowSpan={monthSpan}>{row.month}月</td>
                  )}
                  <td className="border border-black text-center font-bold bg-slate-50">{row.weekNum}</td>
                  {row.dates.map((dStr, dIdx) => {
                    const dateObj = parseDate(dStr);
                    const isOutside = dStr < headerInfo.semesterStartDate || dStr > headerInfo.semesterEndDate;
                    const dayEvents = events.filter(e => isDateInRange(dStr, e.startDate, e.endDate));
                    const isHoli = dayEvents.some(e => e.isHoliday) || dIdx === 0 || dIdx === 6;
                    const isImp = dayEvents.some(e => e.isImportant);

                    let bg = "bg-white";
                    if (isOutside) bg = "bg-gray-100";
                    else if (isHoli) bg = "bg-red-50";
                    else if (isImp) bg = "bg-green-200"; // 加深綠色

                    return (
                      <td key={dIdx} className={`border border-black text-center ${bg} ${isHoli ? 'text-red-500 font-bold' : ''} ${isOutside ? 'text-gray-400' : ''}`}>
                        {dateObj.getDate()}
                      </td>
                    );
                  })}
                  <td className="border border-black p-1.5 align-top text-[10px]">
                    {weekEvents.filter(e => isAssessment(e.title)).map((e, i) => (
                      <div key={i} className="mb-1 font-bold text-blue-800">• {e.title}</div>
                    ))}
                  </td>
                  <td className="border border-black p-1.5 align-top text-[10px]">
                    {weekEvents.filter(e => !e.isHoliday && e.tag !== '備註' && !isAssessment(e.title)).map((e, i) => (
                      <div key={i} className={`mb-1 ${e.isImportant ? 'font-bold text-green-900' : ''}`}>• <span className="text-[9px] text-slate-400">[{formatDateToShort(e.startDate, e.isMonthOnly)}]</span> {e.title}</div>
                    ))}
                  </td>
                  <td className="border border-black p-1.5 align-top text-[10px] text-red-600 font-bold">
                    {weekEvents.filter(e => e.isHoliday || e.tag === '備註').map((e, i) => (
                      <div key={i} className="mb-1">• {e.title}</div>
                    ))}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      );
    };

    // --- 3. 行政分處室報表表格 (修正對齊) ---
    const DepartmentTable = ({ year, monthIdx, events }) => {
      const depts = ["教務處", "學務處", "總務處", "備註"];
      const mEvents = events.filter(e => {
        const d = parseDate(e.startDate);
        return d.getMonth() === monthIdx && d.getFullYear() === year;
      }).sort((a, b) => a.startDate.localeCompare(b.startDate));

      return (
        <table className="w-full border-collapse border border-black text-[11px] bg-white">
          <thead>
            <tr className="bg-gray-200 font-bold">
              {depts.map(d => <th key={d} className="border border-black p-2 w-1/4 text-center text-sm">{d}</th>)}
            </tr>
          </thead>
          <tbody>
            <tr>
              {depts.map(dept => (
                <td key={dept} className="border border-black p-2 align-top h-52">
                  {mEvents.filter(e => (dept === e.tag || (dept === "備註" && e.isHoliday))).map((e, i) => (
                    <div key={i} className="flex items-center gap-2 mb-2 leading-tight">
                      <span className="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded-full shrink-0 border border-blue-200 min-w-[38px] text-center">
                        {formatDateToShort(e.startDate, e.isMonthOnly)}
                      </span>
                      <span className={`flex-1 ${e.isHoliday ? 'text-red-500 font-bold' : (e.isImportant ? 'text-green-900 font-bold' : 'text-slate-800 font-medium')}`}>
                        {e.title}
                      </span>
                    </div>
                  ))}
                </td>
              ))}
            </tr>
          </tbody>
        </table>
      );
    };

    // --- 4. 日曆網格組件 (恢復出席天數計算) ---
    const CalendarGrid = ({ y, m, events, headerInfo, weekMap, isMain, isSuperCompact }) => {
      const firstDay = new Date(y, m, 1).getDay();
      const days = new Date(y, m + 1, 0).getDate();
      const rows = Math.ceil((firstDay + days) / 7);
      let cellHeight = isMain ? 'h-24' : (isSuperCompact ? 'h-[20px]' : 'h-10');

      const getWeekNumber = (row) => {
        const rowSun = new Date(y, m, 1);
        rowSun.setDate(1 - rowSun.getDay() + row * 7);
        return weekMap[toLocalDateStr(rowSun)] || "";
      };

      // 計算出席天數
      const attendanceDays = useMemo(() => {
        let count = 0;
        for (let d = 1; d <= days; d++) {
          const dStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          if (dStr >= headerInfo.semesterStartDate && dStr <= headerInfo.semesterEndDate) {
            if (!isWeekendDay(dStr)) {
              const isHoli = events.some(e => e.isHoliday && isDateInRange(dStr, e.startDate, e.endDate));
              if (!isHoli) count++;
            }
          }
        }
        return count;
      }, [y, m, days, events, headerInfo]);

      return (
        <div className={`border border-black rounded bg-white text-black overflow-hidden shadow-sm ${isMain ? 'p-1' : 'p-0'}`}>
          <div className={`font-bold text-center bg-gray-100 border-b border-black mb-px ${isMain ? 'text-xl py-2' : 'text-[11px] py-0.5'}`}>{m + 1}月</div>
          <div className={`grid grid-cols-8 text-center font-bold border-b border-black bg-slate-50 ${isMain ? 'text-sm' : 'text-[8px]'}`}>
            <div className="bg-blue-100 text-blue-700 border-r border-black/10">週</div>
            <div className="text-red-600">日</div>{['一', '二', '三', '四', '五'].map(d => <div key={d}>{d}</div>)}<div className="text-red-600">六</div>
          </div>
          <div className="grid grid-cols-8 gap-px bg-gray-400 border border-black">
            {[...Array(rows)].map((_, r) => (
              <Fragment key={r}>
                <div className={`bg-blue-50 flex items-center justify-center font-bold text-blue-700 border-r border-gray-200 ${cellHeight} ${isMain ? 'text-sm' : 'text-[9px]'}`}>{getWeekNumber(r)}</div>
                {[...Array(7)].map((_, c) => {
                  const dNum = r * 7 + c - firstDay + 1;
                  const isValid = dNum > 0 && dNum <= days;
                  const dStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(dNum).padStart(2, '0')}`;
                  const dayEvents = events.filter(e => !e.isMonthOnly && isDateInRange(dStr, e.startDate, e.endDate));
                  const isHoli = dayEvents.some(e => e.isHoliday) || (isValid && (c === 0 || c === 6));
                  const isImp = dayEvents.some(e => e.isImportant);

                  let bg = "bg-white";
                  if (isValid && isHoli) bg = "bg-red-50";
                  else if (isValid && isImp) bg = "bg-green-200"; // 加深綠色

                  return (
                    <div key={c} className={`${bg} border-r border-b border-gray-100 ${cellHeight} flex flex-col items-center p-0.5`}>
                      <span className={`${isHoli ? 'text-red-500 font-bold' : ''} ${isMain ? 'text-base' : 'text-[10px]'}`}>{isValid ? dNum : ''}</span>
                      {isMain && isValid && dayEvents.map(e => (
                        <div key={e.id} className={`w-full truncate text-[9px] mt-0.5 px-0.5 rounded shadow-sm border border-black/5 ${e.isImportant ? 'bg-green-700 text-white font-bold' : (e.isHoliday ? 'bg-red-700 text-white font-bold' : 'bg-white/70 text-slate-600')}`}>
                          {e.title}
                        </div>
                      ))}
                    </div>
                  );
                })}
              </Fragment>
            ))}
          </div>
          {!isSuperCompact && (
            <div className={`text-center font-bold text-blue-800 bg-slate-50 border-t border-black ${isMain ? 'text-sm py-1' : 'text-[9px] py-0.5'}`}>
              學生出席天數：{attendanceDays}天
            </div>
          )}
        </div>
      );
    };

    // --- 5. 主程式 (App) ---
    const App = () => {
      const [events, setEvents] = useState(() => JSON.parse(localStorage.getItem('school_calendar_events') || '[]'));
      const [headerInfo, setHeaderInfo] = useState(() => JSON.parse(localStorage.getItem('school_calendar_header') || JSON.stringify({
        schoolName: "OO市OO區OO國民小學", academicYear: "114", semester: "第二學期",
        version: "115.02.20修正版", semesterStartDate: "2026-02-11", semesterEndDate: "2026-06-30", startWeekNumber: "1"
      })));
      const [printMode, setPrintMode] = useState('bureau');
      const [showPreview, setShowPreview] = useState(false);
      const [showExportMenu, setShowExportMenu] = useState(false);
      const [showClearModal, setShowClearModal] = useState(false);
      const [newEvent, setNewEvent] = useState({ startDate: toLocalDateStr(new Date()), endDate: toLocalDateStr(new Date()), title: '', tag: '教務處', isHoliday: false, isImportant: false, isMonthOnly: false });

      useEffect(() => { localStorage.setItem('school_calendar_events', JSON.stringify(events)); }, [events]);
      useEffect(() => { localStorage.setItem('school_calendar_header', JSON.stringify(headerInfo)); }, [headerInfo]);

      const weekMap = useMemo(() => {
        const map = {};
        const start = parseDate(headerInfo.semesterStartDate);
        const end = parseDate(headerInfo.semesterEndDate);
        let currSun = new Date(start); currSun.setDate(start.getDate() - start.getDay());
        let count = parseInt(headerInfo.startWeekNumber) || 1;
        while (currSun <= end) {
          map[toLocalDateStr(currSun)] = count++;
          currSun.setDate(currSun.getDate() + 7);
        }
        return map;
      }, [headerInfo]);

      const semesterRange = useMemo(() => {
        const start = parseDate(headerInfo.semesterStartDate);
        const end = parseDate(headerInfo.semesterEndDate);
        const res = [];
        let curr = new Date(start.getFullYear(), start.getMonth(), 1);
        while (curr <= end) { res.push({ year: curr.getFullYear(), month: curr.getMonth() }); curr.setMonth(curr.getMonth() + 1); }
        return res;
      }, [headerInfo]);

      const handleImportJSON = (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader(); reader.onload = (evt) => {
          try {
            const data = JSON.parse(evt.target.result);
            if (Array.isArray(data)) setEvents(prev => [...prev, ...data.map(d => ({ ...d, id: Date.now() + Math.random() }))]);
          } catch (err) { alert("JSON格式錯誤"); }
        }; reader.readAsText(file);
      };

      const handleImportExcel = (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader(); reader.onload = (evt) => {
          const wb = XLSX.read(evt.target.result, { type: 'binary' });
          const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
          setEvents(prev => [...prev, ...data.map(row => ({
            id: Date.now() + Math.random(),
            startDate: row['開始日期'] || toLocalDateStr(new Date()),
            endDate: row['結束日期'] || row['開始日期'],
            title: row['事項名稱'] || '未命名',
            tag: row['處室單位'] || '教務處',
            isHoliday: row['是否放假'] === '是',
            isImportant: row['是否重要'] === '是',
            isMonthOnly: row['日期未定'] === '是'
          }))]);
        }; reader.readAsBinaryString(file);
      };

      const handleAddEvent = () => {
        if (!newEvent.title) return;
        const eventToSave = { ...newEvent, id: Date.now() };
        if (newEvent.isMonthOnly) {
          const d = parseDate(newEvent.startDate);
          const firstDay = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-01`;
          eventToSave.startDate = firstDay; eventToSave.endDate = firstDay;
        }
        setEvents([...events, eventToSave]);
        setNewEvent({ ...newEvent, title: '', isHoliday: false, isImportant: false });
      };

      return (
        <div className="min-h-screen text-black pb-20">
          <nav className="bg-white border-b sticky top-0 z-30 px-6 py-4 flex justify-between items-center shadow-sm print:hidden">
            <div className="flex items-center gap-3"><Icon name="calendar" className="text-blue-600" size={24} /><h1 className="text-xl font-bold text-slate-700 tracking-tight">學校行事曆管理系統 v2.7</h1></div>
            <div className="flex gap-2">
              <div className="relative">
                <button onClick={() => setShowExportMenu(!showExportMenu)} className="flex items-center gap-2 px-4 py-2 border rounded-lg bg-white font-bold hover:bg-slate-50 transition-all text-black">
                  <Icon name="share-2" /> 預覽、匯出與備份 <Icon name="chevron-down" size={14} />
                </button>
                {showExportMenu && (
                  <div className="absolute right-0 mt-2 w-72 bg-white border rounded-xl shadow-2xl py-2 z-50 text-sm overflow-hidden text-black">
                    <button onClick={() => { setPrintMode('bureau'); setShowPreview(true); setShowExportMenu(false); }} className="w-full text-left px-4 py-3 hover:bg-blue-50 flex items-center gap-3 font-bold text-blue-700"><Icon name="layout" />教育局連續表格版</button>
                    <button onClick={() => { setPrintMode('report'); setShowPreview(true); setShowExportMenu(false); }} className="w-full text-left px-4 py-3 hover:bg-slate-50 flex items-center gap-3 font-bold text-slate-700"><Icon name="eye" />行政分處室報表</button>
                    <button onClick={() => { setPrintMode('calendar'); setShowPreview(true); setShowExportMenu(false); }} className="w-full text-left px-4 py-3 hover:bg-slate-50 flex items-center gap-3 font-bold text-black"><Icon name="calendar-days" />精美月曆 (大格子版)</button>
                    <button onClick={() => { setPrintMode('compact'); setShowPreview(true); setShowExportMenu(false); }} className="w-full text-left px-4 py-3 hover:bg-orange-50 flex items-center gap-3 font-bold text-orange-700"><Icon name="file-text" />一頁重要行事簡曆</button>
                    <div className="border-t my-1"></div>
                    <button onClick={() => { const blob = new Blob([JSON.stringify(events, null, 2)], { type: 'application/json' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `行事曆備份_${headerInfo.schoolName}.json`; link.click(); }} className="w-full text-left px-4 py-2 hover:bg-amber-50 text-amber-700 font-medium flex items-center gap-2 text-black"><Icon name="save" size={14} />下載資料備份 (JSON)</button>
                    <button onClick={() => { const data = events.map(e => ({ '開始日期': e.startDate, '結束日期': e.endDate, '事項名稱': e.title, '處室單位': e.tag, '是否放假': e.isHoliday ? '是' : '否', '是否重要': e.isImportant ? '是' : '否', '日期未定': e.isMonthOnly ? '是' : '否' })); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "行事曆"); XLSX.writeFile(wb, `${headerInfo.schoolName}_行事曆.xlsx`); }} className="w-full text-left px-4 py-2 hover:bg-green-50 text-green-700 font-medium flex items-center gap-2 text-black"><Icon name="download" size={14} />下載 Excel 檔案</button>
                  </div>
                )}
              </div>
              <button onClick={() => { setPrintMode('bureau'); setShowPreview(true); }} className="px-5 py-2 bg-slate-800 text-white rounded-lg font-bold flex items-center gap-2 shadow-md hover:bg-black transition-all">
                <Icon name="printer" size={16} /> 快速預覽/列印
              </button>
            </div>
          </nav>

          <main className="max-w-6xl mx-auto p-6 flex flex-col gap-8 print:hidden">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 text-black">
              {/* 基礎設定 */}
              <section className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                <h3 className="font-bold text-lg flex items-center gap-2 text-slate-800"><Icon name="settings" /> 1. 基礎設定</h3>
                <div className="space-y-3">
                  <div className="space-y-1"><label className="text-xs font-bold text-slate-400 ml-1">學校名稱</label><input className="w-full p-2.5 bg-slate-50 border border-slate-200 rounded-lg font-bold text-black" value={headerInfo.schoolName} onChange={e => setHeaderInfo({ ...headerInfo, schoolName: e.target.value })} /></div>
                  <div className="grid grid-cols-2 gap-4">
                    <input className="p-2.5 bg-slate-50 border rounded-lg font-bold text-black" value={headerInfo.academicYear} onChange={e => setHeaderInfo({ ...headerInfo, academicYear: e.target.value })} placeholder="學年度" />
                    <input className="p-2.5 bg-slate-50 border rounded-lg font-bold text-black" value={headerInfo.semester} onChange={e => setHeaderInfo({ ...headerInfo, semester: e.target.value })} placeholder="學期" />
                  </div>
                  <div className="grid grid-cols-3 gap-3 text-xs font-bold text-slate-400">
                    <div>學期開始<input type="date" className="w-full p-2 border border-slate-200 rounded mt-1 text-black font-bold" value={headerInfo.semesterStartDate} onChange={e => setHeaderInfo({ ...headerInfo, semesterStartDate: e.target.value })} /></div>
                    <div>學期結束<input type="date" className="w-full p-2 border border-slate-200 rounded mt-1 text-black font-bold" value={headerInfo.semesterEndDate} onChange={e => setHeaderInfo({ ...headerInfo, semesterEndDate: e.target.value })} /></div>
                    <div>起始週次<input type="number" className="w-full p-2 border border-blue-200 bg-blue-50 rounded mt-1 text-blue-700 font-bold" value={headerInfo.startWeekNumber} onChange={e => setHeaderInfo({ ...headerInfo, startWeekNumber: e.target.value })} /></div>
                  </div>
                </div>
              </section>

              {/* 新增事項 */}
              <section className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                <h3 className="font-bold text-lg flex items-center gap-2 text-blue-600 font-bold"><Icon name="plus-circle" /> 2. 新增事項</h3>
                <div className="grid grid-cols-2 gap-4">
                  <input type="date" className="p-2 border rounded font-bold text-black" value={newEvent.startDate} onChange={e => setNewEvent({ ...newEvent, startDate: e.target.value, endDate: e.target.value })} />
                  {!newEvent.isMonthOnly && <input type="date" className="p-2 border rounded font-bold text-black" value={newEvent.endDate} onChange={e => setNewEvent({ ...newEvent, endDate: e.target.value })} />}
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <input className="p-2 border rounded font-bold text-black" value={newEvent.title} onChange={e => setNewEvent({ ...newEvent, title: e.target.value })} placeholder="事項名稱 (如：期中考)" />
                  <select className="p-2 border rounded font-bold bg-slate-50 text-black" value={newEvent.tag} onChange={e => setNewEvent({ ...newEvent, tag: e.target.value })}>
                    <option>教務處</option><option>學務處</option><option>總務處</option><option>備註</option>
                  </select>
                </div>
                <div className="flex gap-4 flex-wrap text-black">
                  <label className="flex items-center gap-2 text-xs font-bold cursor-pointer text-red-600"><input type="checkbox" checked={newEvent.isHoliday} onChange={e => setNewEvent({ ...newEvent, isHoliday: e.target.checked })} /> 放假日</label>
                  <label className="flex items-center gap-2 text-xs font-bold cursor-pointer text-green-700"><input type="checkbox" checked={newEvent.isImportant} onChange={e => setNewEvent({ ...newEvent, isImportant: e.target.checked })} /> 重要考查</label>
                  <label className="flex items-center gap-2 text-xs font-bold cursor-pointer text-blue-600"><input type="checkbox" checked={newEvent.isMonthOnly} onChange={e => setNewEvent({ ...newEvent, isMonthOnly: e.target.checked })} /> 日期未定 (待定)</label>
                </div>
                <button onClick={handleAddEvent} className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg">確認加入清單</button>
              </section>
            </div>

            {/* 清單區域 */}
            <section className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden flex flex-col text-black">
              <div className="p-4 border-b bg-slate-50 flex justify-between items-center text-black flex-wrap gap-2">
                <h3 className="font-bold flex items-center gap-2 text-slate-700"><Icon name="list" /> 已登錄事項 ({events.length})</h3>
                <div className="flex gap-2 text-black text-xs font-bold">
                  <label className="px-3 py-1.5 border border-slate-300 rounded-lg bg-white cursor-pointer hover:bg-slate-100 flex items-center gap-2"><Icon name="upload" size={14} /> 匯入 JSON<input type="file" className="hidden" accept=".json" onChange={handleImportJSON} /></label>
                  <label className="px-3 py-1.5 border border-slate-300 rounded-lg bg-white cursor-pointer hover:bg-slate-100 flex items-center gap-2"><Icon name="file-spreadsheet" size={14} className="text-green-600" /> 匯入 Excel<input type="file" className="hidden" accept=".xlsx" onChange={handleImportExcel} /></label>
                  <button onClick={() => setShowClearModal(true)} className="px-3 py-1.5 bg-red-50 text-red-600 border border-red-200 rounded-lg hover:bg-red-100">清空清單</button>
                </div>
              </div>
              <div className="max-h-[500px] overflow-y-auto custom-scroll divide-y">
                {events.sort((a, b) => a.startDate.localeCompare(b.startDate)).map(e => (
                  <div key={e.id} className="p-4 flex justify-between items-center hover:bg-slate-50 transition-colors text-black">
                    <div className="flex gap-6 items-center">
                      <div className="text-[11px] w-24 text-slate-400 font-mono tracking-tighter">
                        {e.isMonthOnly ? <span className="text-blue-500 font-bold px-1 bg-blue-50 rounded">待定 {e.startDate.substring(0, 7)}</span> : e.startDate}
                      </div>
                      <span className={`text-[10px] px-2 py-0.5 rounded-full border font-bold ${e.isHoliday ? 'bg-red-50 text-red-600 border-red-200' : 'bg-white border-slate-200 text-slate-600'}`}>{e.tag}</span>
                      <span className={`font-bold text-slate-800 ${e.isImportant ? 'text-green-700' : (e.isHoliday ? 'text-red-500' : '')}`}>{e.title}</span>
                    </div>
                    <button onClick={() => setEvents(events.filter(x => x.id !== e.id))} className="text-slate-300 hover:text-red-600 p-1 rounded-full transition-all"><Icon name="trash-2" size={18} /></button>
                  </div>
                ))}
              </div>
            </section>
          </main>

          {/* 清空確認視窗 */}
          {showClearModal && (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 modal-overlay text-black text-black">
              <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-8 text-center space-y-6">
                <div className="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto"><Icon name="alert-triangle" size={32} /></div>
                <div className="space-y-2">
                  <h3 className="text-xl font-bold text-slate-800">確定要清空嗎？</h3>
                  <p className="text-sm text-slate-500">此動作無法復原，所有資料將被永久刪除。</p>
                </div>
                <div className="flex gap-3 pt-2">
                  <button onClick={() => setShowClearModal(false)} className="flex-1 py-3 border border-slate-200 rounded-xl font-bold hover:bg-slate-50 text-slate-600">取消</button>
                  <button onClick={() => { setEvents([]); setShowClearModal(false); }} className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 shadow-lg">確定清空</button>
                </div>
              </div>
            </div>
          )}

          {/* 預覽 Modal */}
          {showPreview && (
            <div className="fixed inset-0 bg-slate-900/95 backdrop-blur-sm z-50 flex items-center justify-center p-4 print:bg-white print:p-0">
              <div className="bg-white w-full max-w-5xl max-h-[95vh] rounded-3xl overflow-hidden flex flex-col print:max-h-none print:rounded-none shadow-2xl">
                <div className="p-4 border-b flex justify-between items-center bg-white font-bold text-slate-700 print:hidden shadow-sm">
                  <span className="text-blue-600 text-lg font-bold">預覽：{printMode === 'bureau' ? '教育局版' : (printMode === 'report' ? '行政報表' : (printMode === 'calendar' ? '精美月曆' : '一頁簡曆'))}</span>
                  <div className="flex gap-3">
                    <button onClick={() => window.print()} className="px-6 py-2 bg-blue-600 text-white rounded-xl flex items-center gap-2 font-bold shadow-lg shadow-blue-200"><Icon name="printer" /> 確認列印 / 存為 PDF</button>
                    <button onClick={() => setShowPreview(false)} className="px-4 py-2 border border-slate-200 rounded-xl bg-white font-bold">關閉</button>
                  </div>
                </div>
                <div className="flex-1 overflow-y-auto p-12 bg-slate-100 print:bg-white print:p-0 custom-scroll">
                  <div id="print-area" className="bg-white p-12 mx-auto shadow-2xl print:shadow-none min-h-[297mm] text-black" style={{ width: '210mm' }}>
                    <div className="text-center mb-8 text-black">
                      <h2 className="text-2xl font-bold tracking-[0.2em] text-slate-800">{headerInfo.schoolName}</h2>
                      <h1 className="text-3xl font-bold mt-2 tracking-tight">{headerInfo.academicYear}學年度{headerInfo.semester}各處室暫定行事曆</h1>
                      <div className="text-right text-[12px] mt-4 text-slate-500 font-bold border-b-2 border-slate-800 pb-1">製表日期：{headerInfo.version}</div>
                    </div>

                    {printMode === 'bureau' ? (
                      <BureauTable headerInfo={headerInfo} events={events} weekMap={weekMap} />
                    ) : printMode === 'report' ? (
                      <div className="space-y-12">
                        {semesterRange.map((m, i) => (
                          <div key={i} className="grid grid-cols-12 gap-6 items-start">
                            <div className="col-span-3"><CalendarGrid y={m.year} m={m.month} events={events} headerInfo={headerInfo} weekMap={weekMap} /></div>
                            <div className="col-span-9"><DepartmentTable year={m.year} monthIdx={m.month} events={events} /></div>
                          </div>
                        ))}
                      </div>
                    ) : printMode === 'calendar' ? (
                      <div className="space-y-4">
                        {semesterRange.map((m, i) => (
                          <div key={i} className={`${i > 0 ? 'page-break pt-8' : ''}`}>
                            <CalendarGrid y={m.year} m={m.month} events={events} headerInfo={headerInfo} weekMap={weekMap} isMain={true} />
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="grid grid-cols-2 gap-x-8 gap-y-10">
                        {semesterRange.map((m, i) => (
                          <div key={i} className="flex flex-col gap-3">
                            <div className="flex gap-4 items-start h-full">
                              <div className="w-1/2 h-full"><CalendarGrid y={m.year} m={m.month} events={events} headerInfo={headerInfo} weekMap={weekMap} isSuperCompact={true} /></div>
                              <div className="w-1/2 text-[10px] overflow-hidden leading-snug font-bold">
                                <div className="border-b-2 border-blue-600 mb-2 pb-1 text-blue-700 font-bold text-xs">{m.month + 1}月 大事記</div>
                                <div className="space-y-1">
                                  {events.filter(e => { const d = parseDate(e.startDate); return d.getMonth() === m.month && d.getFullYear() === m.year; }).sort((a, b) => a.startDate.localeCompare(b.startDate)).slice(0, 15).map((e, idx) => (
                                    <div key={idx} className={`flex items-start gap-1 ${e.isHoliday ? 'text-red-500' : (e.isImportant ? 'text-green-900' : 'text-slate-600')}`}>
                                      <span className="shrink-0">•</span>
                                      <span className="shrink-0 font-mono opacity-60">[{formatDateToShort(e.startDate, e.isMonthOnly)}]</span>
                                      <span className="truncate">{e.title}</span>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                    <div className="mt-12 text-[12px] text-slate-500 italic border-t-2 border-slate-100 pt-6 font-bold text-center">
                      <p>※ 本行事曆僅供參考，實際行程請依各處室最終公告為準。</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>

</html>